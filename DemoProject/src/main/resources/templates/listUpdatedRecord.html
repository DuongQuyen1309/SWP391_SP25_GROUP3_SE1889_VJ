<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>Rice Sales Management</title>
    <link rel="stylesheet" href="/css/base.css">
    <style>
        .pagination {
            text-align: center;
            margin-top: 20px;
        }

        .pagination a {
            display: inline-block;
            padding: 8px 16px;
            margin: 4px;
            text-decoration: none;
            background-color: #2c3e50;
            color: white;
            border-radius: 5px;
        }

        .pagination a:hover {
            background-color: #1a252f;
        }

        .pagination span {
            font-size: 18px;
            margin: 0 10px;
        }
        .button-container {
            display: flex;
            justify-content: flex-end; /* CƒÉn c√°c n√∫t v·ªÅ b√™n ph·∫£i */
            gap: 10px; /* Kho·∫£ng c√°ch gi·ªØa c√°c n√∫t */
            align-items: center; /* CƒÉn n√∫t theo chi·ªÅu d·ªçc v·ªõi ti√™u ƒë·ªÅ */
            margin-bottom: 10px;
            margin-top: 60px; /* H·∫° n√∫t xu·ªëng g·∫ßn v·ªõi ti√™u ƒë·ªÅ */
        }

        .button-container button {
            background-color: #d35400; /* M√†u cam */
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-decoration: none;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease-in-out;
            padding: 10px 20px;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .button-container button:hover {
            background-color: #e67e22;
            transform: scale(1.05);
        }
    </style>
    <script src="/js/home.js"></script>

    <script>
        function filterNotes() {
            let params = new URLSearchParams();
            document.querySelectorAll('.filter-input').forEach(input => {
                if (input.value.trim() !== '') { // Ch·ªâ th√™m tham s·ªë n·∫øu c√≥ gi√° tr·ªã
                    params.append(input.name, input.value);
                }
            });
            window.location.href = '/updateLog/listUpdatedRecord?' + params.toString();
        }
        document.addEventListener("DOMContentLoaded", function() {
            updateInputFields(); // G·ªçi ƒë·ªÉ c·∫≠p nh·∫≠t ki·ªÉu input ngay khi trang t·∫£i
            restoreSearchFilters(); // Ph·ª•c h·ªìi gi√° tr·ªã l·ªçc t·ª´ URL
        });

        /**
         * C·∫≠p nh·∫≠t ki·ªÉu input c·ªßa Previous Value & Following Value d·ª±a tr√™n Information Field
         */
        function updateInputFields() {
            let fieldType = document.getElementById("informationField").value;
            let preValueContainer = document.getElementById("preValueContainer");
            let followValueContainer = document.getElementById("followValueContainer");

            let params = new URLSearchParams(window.location.search);
            let preValue = params.get("preValue") || "";
            let followValue = params.get("followValue") || "";

            if (fieldType === "dob") {
                preValueContainer.innerHTML = `<input type="date" class="filter-input" id="preValue" name="preValue" style="width: 100px;" onchange="filterNotes()">`;
                followValueContainer.innerHTML = `<input type="date" class="filter-input" id="followValue" name="followValue" style="width: 100px;" onchange="filterNotes()">`;

                // Ph·ª•c h·ªìi gi√° tr·ªã t√¨m ki·∫øm
                document.getElementById("preValue").value = preValue;
                document.getElementById("followValue").value = followValue;
            }
            else if (fieldType === "gender") {
                preValueContainer.innerHTML = `<select class="filter-input" id="preValue" name="preValue" style="width: 100px;" onchange="filterNotes()">
                                        <option value="">All</option>
                                        <option value="false">Female</option>
                                        <option value="true">Male</option>
                                      </select>`;
                followValueContainer.innerHTML = `<select class="filter-input" id="followValue" name="followValue" style="width: 100px;" onchange="filterNotes()">
                                        <option value="">All</option>
                                        <option value="false">Female</option>
                                        <option value="true">Male</option>
                                      </select>`;

                // Ph·ª•c h·ªìi gi√° tr·ªã t√¨m ki·∫øm
                document.getElementById("preValue").value = preValue;
                document.getElementById("followValue").value = followValue;
            }
            else {
                preValueContainer.innerHTML = `<input type="text" class="filter-input" id="preValue" name="preValue" style="width: 100px;" onchange="filterNotes()">`;
                followValueContainer.innerHTML = `<input type="text" class="filter-input" id="followValue" name="followValue" style="width: 100px;" onchange="filterNotes()">`;

                // Ph·ª•c h·ªìi gi√° tr·ªã t√¨m ki·∫øm
                document.getElementById("preValue").value = preValue;
                document.getElementById("followValue").value = followValue;
            }
        }


        /**
         * G·ªçi khi ng∆∞·ªùi d√πng thay ƒë·ªïi tr∆∞·ªùng t√¨m ki·∫øm
         */
        function handleFieldChange() {
            console.log("Selected Field:", document.getElementById("informationField").value);
            updateInputFields();
            filterNotes(); // T√¨m ki·∫øm ngay sau khi ƒë·ªïi tr∆∞·ªùng
        }

        /**
         * T·ª± ƒë·ªông ph·ª•c h·ªìi gi√° tr·ªã t√¨m ki·∫øm t·ª´ URL khi t·∫£i l·∫°i trang
         */
        function restoreSearchFilters() {
            let params = new URLSearchParams(window.location.search);

            document.querySelectorAll('.filter-input').forEach(input => {
                if (params.has(input.name)) {
                    let value = params.get(input.name);
                    console.log(`Kh√¥i ph·ª•c ${input.name}: ${value}`);

                    if (input.type === "date") {
                        input.value = value.substring(0, 10); // ƒê·ªãnh d·∫°ng YYYY-MM-DD
                    } else if (input.tagName === "SELECT") {
                        input.value = value; // G√°n gi√° tr·ªã l·∫°i cho select
                    } else {
                        input.value = value;
                    }
                }
            });

            // C·∫≠p nh·∫≠t l·∫°i ki·ªÉu input ƒë·ªÉ ƒë·∫£m b·∫£o UI ƒë√∫ng
            updateInputFields();
        }

    </script>
</head>
<body>

<!-- Header -->
<div class="header">
    <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
    <h2><a href="/home">RSMS</a></h2>
    <div class="user-info">
        <img src="/images/account.jpg" alt="User Avatar" class="user-avatar"/>
        <div class="dropdown">
            <span th:text="${account.displayName}" class="user-name" onclick="toggleDropdown()"> ‚ñº</span>
            <div id="dropdown-menu" class="dropdown-content">
                <a href="/user/userprofile">üë§ View Profile</a>
                <a href="/#" id="logout">üö™ Logout</a>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">

    <h2>Feature</h2>
    <a href="/user/userprofile" >Profile</a>
    <a href="/account/listStaff" th:style="${#lists.contains(listHiddenPage, 'listStaff')} ? 'display: none;' : ''">Staff Account Management</a>


    <a href="/product/listProduct" >Rice Management</a>

    <a href="/customer/listCustomer" >Customer Management</a>

    <a href="/warehouse/listWarehouseZone" >WarehouseZone Management</a>


    <a href="/listInvoice" >Invoice Management</a>

</div>


<!-- Content -->
<div class="content" id="content">

    <!-- Modal Form -->
    <!--    <button class="add-customer" onclick="callPage()">Create New Note</button>-->


    <div id="messageBox">
        <script type="text/javascript">
            // G·ªçi h√†m showMessage v·ªõi messageType v√† message t·ª´ flash attributes
            /* Thymeleaf s·∫Ω thay th·∫ø c√°c gi√° tr·ªã n√†y */
            let messageType = '[[${messageType}]]';
            let message = '[[${message}]]';

            if (message && message.trim() !== '') {
                showMessage(messageType, message);
            }
            function callPage() {
                window.location.href ="/customer/listCustomer";
            }
        </script>
    </div>
    <!-- Modal Form -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h1>History about Updated Customer Information</h1>
        <div class="button-container">
            <button onclick="callPage()">Back</button>
        </div>
    </div>

    <div th:if="${errorMessage}" style="color: red; font-weight: bold;">
        <p th:text="${errorMessage}"></p>
    </div>
    <table class="styled-table">
        <thead>
        <tr>
            <td>Id</td>
            <td>Customer Name</td>
            <td>Customer Phone</td>
            <td>Updated By</td>
            <td>Updated At</td>
            <td>Information Field</td>
            <td>Previous Value</td>
            <td>Following Value</td>
        </tr>
        <tr>
            <td>
            </td>
            <td>
            </td>
            <td>
            </td>
            <td>
                <select class="filter-input" name="updatedBy" onchange="filterNotes()" style="width: 90%;">
                    <option value="">All</option>
                    <!-- S·ª≠ d·ª•ng th:each ƒë·ªÉ l·∫∑p qua userList v√† t·∫°o c√°c option -->
                    <option th:each="user : ${usersList}" th:value="${user.id}" th:text="${user.name}"></option>
                </select>
            </td>
            <td class="twin-field" style="width: 5%;">
                <div style="display: flex; gap: 3%; width: 100%;">
                    <input type="datetime-local" class="filter-input" name="updatedDateFrom"
                           onchange="filterNotes()"
                           style="width: 48%;"/>
                    <input type="datetime-local" class="filter-input" name="updatedDateTo"
                           onchange="filterNotes()"
                           style="width: 48%;"/>
                </div>
            </td>
            <td>
                <select class="filter-input" name="informationField" id="informationField" onchange="handleFieldChange()" style="width: 42%;">
                    <option value="">All</option>
                    <option value="name">Name</option>
                    <option value="phone">Phone</option>
                    <option value="address">Address</option>
                    <option value="gender">Gender</option>
                    <option value="dob">Date of Birth</option>
                </select>
            </td>
            <td>
                <span id="preValueContainer">
                    <input type="text" class="filter-input" id="preValue" name="preValue" onchange="filterNotes()" style="width: 40%;">
                </span>
            </td>
            <td>
                <span id="followValueContainer">
                    <input type="text" class="filter-input" id="followValue" name="followValue" onchange="filterNotes()" style="width: 40%;">
                </span>
            </td>
        </tr>
        </thead>
        <tbody>
        <tr th:each="log : ${updateLog}">
            <td th:if="${log != null}" th:text="${log.id}"></td>
            <td th:if="${log != null}">
                <span th:each="customer : ${customerList}"
                th:text="${customer.id == log.customerId ? customer.name : ''}"></span>
            </td>
            <td th:if="${log != null}">
                <span th:each="customer : ${customerList}"
                      th:text="${customer.id == log.customerId ? customer.phone : ''}"></span>
            </td>
            <td th:if="${log != null}">
                <span th:each="user : ${usersList}"
                      th:text="${user.id == log.updatedBy ? user.name : ''}"></span>
            </td>
            <td th:if="${log != null}" th:text="${#temporals.format(log.updatedAt, 'yyyy-MM-dd HH:mm:ss')}"></td>
            <td th:if="${log != null}" th:text="${log.fieldName}"></td>
            <td th:if="${log != null}">
                <span th:if="${log.fieldName == 'gender'}" th:text="${log.oldValue == 'false' ? 'female' : (log.oldValue == 'true' ? 'male' : log.oldValue)}"></span>
                <span th:unless="${log.fieldName == 'gender'}" th:text="${log.oldValue}"></span>
            </td>
            <td th:if="${log != null}">
                <span th:if="${log.fieldName == 'gender'}" th:text="${log.newValue == 'false' ? 'female' : (log.newValue == 'true' ? 'male' : log.newValue)}"></span>
                <span th:unless="${log.fieldName == 'gender'}" th:text="${log.newValue}"></span>
            </td>
        </tr>
        </tbody>
    </table>
    <div class="pagination">
        <a th:if="${currentPage > 0}"
           th:href="@{/updateLog/listUpdatedRecord(page=${currentPage - 1}, size=${size},
       updatedBy=${updatedBy}, updatedDateFrom=${updatedDateFrom},
       updatedDateTo=${updatedDateTo},
       informationField=${informationField},
       preValue=${preValue},
       followValue=${followValue},
       status=${status})}">
            Previous
        </a>

        <span>Page <span th:text="${currentPage + 1}"></span> of <span th:inline="text">[[${totalPages == 0 ? 1 : totalPages}]]</span></span>

        <a th:if="${currentPage + 1 < totalPages}"
           th:href="@{/updateLog/listUpdatedRecord(page=${currentPage + 1}, size=${size},
       updatedBy=${updatedBy}, updatedDateFrom=${updatedDateFrom},
       updatedDateTo=${updatedDateTo},
       informationField=${informationField},
       preValue=${preValue},
       followValue=${followValue},
       status=${status})}">
            Next
        </a>
    </div>
</div>
<footer>
    &copy; 2025 Rice Sales Management. All Rights Reserved.
</footer>

</body>
</html>

