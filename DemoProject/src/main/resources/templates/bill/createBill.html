<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω b√°n h√†ng</title>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/bill.css">
  <link rel="icon" type="image/x-icon" th:href="@{/images/account.jpg}">

  <script src="/js/home.js"></script>

</head>
<body>
<!-- Header -->
<div class="header">
  <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
  <h2><a href="/home">RSMS</a></h2>
  <div class="user-info">
    <img  th:src="${user.avatar}" alt="User Avatar" class="user-avatar"/>
    <div class="dropdown">
      <span th:text="${account.displayName}" class="user-name" onclick="toggleDropdown()"> ‚ñº</span>
      <div id="dropdown-menu" class="dropdown-content">
        <a href="/user/userprofile">üë§ View Profile</a>
        <a href="/user/changepw" id="changepw">üîë Change password</a>
        <a href="/static#" id="logout">üö™ Logout</a>

      </div>
    </div>
  </div>

</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar" style="height: 100%;">
  <h2>Feature</h2>
  <a href="/user/userprofile">Profile</a>
  <a href="/account/listStaff" th:style="${#lists.contains(listHiddenPage, 'listStaff')} ? 'display: none;' : ''">Staff Account Management</a>
  <a href="/product/listProduct">Rice Management</a>
  <a href="/customer/listCustomer">Customer Management</a>
  <a href="/warehouse/listWarehouseZone">Warehouse Management</a>
  <a href="/bill/listBill">Invoice Management</a>
</div>
<div class="content">
<!--<div class="search-container">-->
<!--  <span class="search-icon">üîç</span>-->
<!--  <input type="text" placeholder="T√¨m ki·∫øm theo m√£">-->
<!--</div>-->
  <div class="tab-container">
    <div class="tab active" data-tab="tab-1" onclick="switchTab('tab-1')">
      <span class="tab-title">H√≥a ƒë∆°n 1</span>
      <span class="tab-close">√ó</span>
    </div>
    <button class="add-tab">+</button>
  </div>


<div class="main-container">
  <div class="left-panel">
    <!-- N√∫t th√™m s·∫£n ph·∫©m (ban ƒë·∫ßu hi·ªÉn th·ªã) -->
    <div class="add-product" id="add-product" onclick="showProductModal()">
      <span>+ T√™n s·∫£n ph·∫©m</span>
    </div>

    <!-- Modal ch·ª©a danh s√°ch s·∫£n ph·∫©m -->
    <div id="product-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeProductModal()">&times;</span>
        <h2>Ch·ªçn s·∫£n ph·∫©m</h2>

        <!-- √î t√¨m ki·∫øm s·∫£n ph·∫©m -->
        <input type="text" id="search-product" class="styled-input" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." onkeyup="searchProduct()">

        <!-- Danh s√°ch s·∫£n ph·∫©m -->
        <div id="product-list" class="product-list">
          <p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>
        </div>
      </div>
    </div>


    <div class="products-container">
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>S·∫£n ph·∫©m</th>
          <th class="quantity-cell">SL</th>
          <th class="price-cell">ƒê∆°n gi√°</th>
          <th class="price-cell">Th√†nh ti·ªÅn</th>
          <th>X√≥a</th>
        </tr>
        </thead>
        <tbody id="selected-products">
        <!-- C√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </tbody>
      </table>

    </div>



  </div>

  <div class="right-panel">
    <div class="section">
      <div class="section-header">Th√¥ng tin kh√°ch h√†ng</div>
      <div class="section-content">
        <div class="form-group">
           <div class="customer-buttons">
            <button id="search-customer-btn">üîç T√¨m</button>
            <button id="add-customer-btn">‚ûï Th√™m</button>
          </div>
        </div>
        <div class="form-group">
          <label>Kh√°ch h√†ng</label>
          <input type="text" class="form-control" id="customer-name"  >
        </div>
        <div class="form-group">
          <label>ƒê·ªãa ch·ªâ</label>
          <input type="text" class="form-control" id="customer-address"  >
        </div>
        <div class="form-group">
          <label>S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="text" class="form-control" id="customer-phone"  >
        </div>
        <div class="form-group">
          <label>Gender</label>
          <input type="text" class="form-control" id="customer-gender" >
        </div>
        <div class="form-group">
          <label>Date Of Birth</label>
          <input type="text" class="form-control" id="customer-dob" >
        </div>
        <div class="form-group">
          <label>N·ª£ c≈©</label>
          <input type="text" class="form-control" id="customer-moneystate" readonly>
        </div>
        <div class="form-group">
          <label>T·ªïng c√¥n n·ª£</label>
          <input type="text" class="form-control" placeholder="T·ªïng c√¥n n·ª£" readonly>
        </div>
      </div>
    </div>
    <!-- Popup t√¨m ki·∫øm kh√°ch h√†ng -->
    <div id="customer-search-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeCustomerSearchModal()">&times;</span>
        <h2>T√¨m ki·∫øm kh√°ch h√†ng</h2>
        <input type="text" id="search-customer-input" class="styled-input" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng..." onkeyup="searchCustomer()">
        <div id="customer-list" class="customer-list"></div>
      </div>
    </div>

    <!-- Popup th√™m kh√°ch h√†ng -->
    <div id="add-customer-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeAddCustomerModal()">&times;</span>
        <h2>Th√™m kh√°ch h√†ng m·ªõi</h2>
        <div class="form-group">
          <label>T√™n kh√°ch h√†ng</label>
          <input type="text" class="form-control" id="new-customer-name">
        </div>
        <div class="form-group">
          <label>Gender:</label>
          <select id="new-customer-gender">
            <option value="true" >Male</option>
            <option value="false" >Female</option>
          </select>
        </div>
        <div class="form-group">
          <label>ƒê·ªãa ch·ªâ</label>
          <input type="text" class="form-control" id="new-customer-address">
        </div>
        <div class="form-group">
          <label>S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="text" class="form-control" id="new-customer-phone">
        </div>
        <div class="form-group">
          <label>Date of birth</label>
          <input type="date" class="form-control" id="new-customer-dob">
        </div>


        <button id="save-customer-btn">L∆∞u kh√°ch h√†ng</button>
      </div>
    </div>

    <div class="section">
      <div class="section-header">T·ªïng c·ªông</div>
      <div class="section-content">
        <div class="total-row">
          <span class="total-label">T·ªïng ti·ªÅn h√†ng:</span>
          <span class="total-value" id="total-amount">0</span>
        </div>
        <div class="total-row">
          <span class="total-label">Kh√°ch c·∫ßn tr·∫£:</span>
          <span class="total-value highlight" id="customer-pay">0</span>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Thanh to√°n</div>
      <div class="section-content">
        <div class="total-row">
          <span class="total-label">Kh√°ch thanh to√°n:</span>
          <span class="total-value highlight" id="display-payment-amount">0</span> <!-- Ch·ªâ hi·ªÉn th·ªã s·ªë ti·ªÅn -->
        </div>

        <div class="payment-methods" style="margin-bottom: 10px">
          <div class="payment-method">
            <input type="radio" name="payment" id="pay-all">
            <label for="pay-all">Tr·∫£ h·∫øt</label>
          </div>
          <div class="payment-method">
            <input type="radio" name="payment" id="pay-rent">
            <label for="pay-rent">Tr·∫£ n·ª£</label>
          </div>
          <div class="payment-method">
            <input type="checkbox" name="payment" id="loading">
            <label for="loading">B·ªëc h√†ng</label>
          </div>
        </div>
        <!-- √î nh·∫≠p ti·ªÅn tr·∫£ n·ª£, m·∫∑c ƒë·ªãnh ·∫©n -->
        <div id="debt-payment-container" style="display: none; margin-bottom: 10px">
          <label>Nh·∫≠p s·ªë ti·ªÅn tr·∫£ n·ª£:</label>
          <input type="text" class="form-control" id="debt-payment-amount" value="0">
        </div>

        <div class="payment-amount">
          <div>Ti·ªÅn b·ªëc h√†ng:</div>
          <input type="text" class="form-control payment-input" id="loading-amount" value="0" readonly>
        </div>

        <button class="checkout-button">THANH TO√ÅN</button>
      </div>
    </div>
  </div>
</div>

</div>
<footer>
  &copy; 2025 Rice Sales Management. All Rights Reserved.
</footer>

<script>

  let tabData = {}; // L∆∞u d·ªØ li·ªáu cho t·ª´ng tab
  let activeTabId = "tab-1"; // ID c·ªßa tab ƒëang ƒë∆∞·ª£c ch·ªçn

  function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN').format(price);
  }

  function parsePrice(priceStr) {
    return parseInt(priceStr.replace(/[,.]/g, '')) || 0;
  }

  function showProductModal() {
    document.getElementById("product-modal").style.display = "flex";
  }

  function closeProductModal() {
    document.getElementById("product-modal").style.display = "none";
  }

  /* H√†m t√¨m ki·∫øm s·∫£n ph·∫©m */
  function searchProduct() {
    let keyword = document.getElementById("search-product").value;
    let productList = document.getElementById("product-list");
    if (keyword.length >= 1) {

      fetch(`/bill/searchProducts?keyword=${keyword}`)
              .then(response => response.json())
              .then(data => {
                if (data.length === 0) {
                  productList.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</p>"; // N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£
                } else {
                  productList.innerHTML = data.map(product => `
                        <div class="product-item" onclick="selectProduct(${product.id}, '${product.name}', ${product.price})">
                            ${product.name} - ${product.price} VND
                        </div>
                    `).join(""); // T·∫°o danh s√°ch s·∫£n ph·∫©m m·ªõi
                }
              })
              .catch(error => console.error("L·ªói t√¨m ki·∫øm:", error));
    } else {
      document.getElementById("product-list").innerHTML = "<p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>";
    }
  }


  /* Khi ch·ªçn s·∫£n ph·∫©m, th√™m v√†o h√≥a ƒë∆°n v√† ƒë√≥ng modal */
  function selectProduct(id, name, price) {
    if (!tabData[activeTabId])tabData[activeTabId] = { customer: {}, products: [] };

    let existingProduct = tabData[activeTabId].products.find(p => p.id === id);
    if (existingProduct) {
      alert("S·∫£n ph·∫©m n√†y ƒë√£ ƒë∆∞·ª£c th√™m v√†o tab n√†y!");
      return;
    }

    tabData[activeTabId].products.push({ id, name, price, quantity: 1 });
    document.getElementById("search-product").value = ""; // X√≥a n·ªôi dung t√¨m ki·∫øm
    document.getElementById("product-list").innerHTML = "<p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>";
    renderProducts(activeTabId);
    updateOrderTotal(activeTabId);

    closeProductModal(); // ƒê√≥ng modal sau khi ch·ªçn s·∫£n ph·∫©m
  }

  // M·ªü popup t√¨m ki·∫øm kh√°ch h√†ng
  document.getElementById("search-customer-btn").addEventListener("click", function () {
    document.getElementById("customer-search-modal").style.display = "flex";
  });

  // ƒê√≥ng popup t√¨m ki·∫øm kh√°ch h√†ng
  function closeCustomerSearchModal() {
    document.getElementById("customer-search-modal").style.display = "none";
  }

  // M·ªü popup th√™m kh√°ch h√†ng
  document.getElementById("add-customer-btn").addEventListener("click", function () {
    document.getElementById("add-customer-modal").style.display = "flex";
  });

  // ƒê√≥ng popup th√™m kh√°ch h√†ng
  function closeAddCustomerModal() {
    document.getElementById("add-customer-modal").style.display = "none";
  }



  // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi tr√™n c√°c √¥ nh·∫≠p th√¥ng tin kh√°ch h√†ng
  document.getElementById("customer-name").addEventListener("input", updateCustomerData);
  document.getElementById("customer-phone").addEventListener("input", updateCustomerData);
  document.getElementById("customer-address").addEventListener("input", updateCustomerData);
  document.getElementById("customer-dob").addEventListener("input", updateCustomerData);
  document.getElementById("customer-gender").addEventListener("input", updateCustomerData);
  document.getElementById("customer-moneystate").addEventListener("input", updateCustomerData);

  // H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu v√†o tab hi·ªán t·∫°i
  function updateCustomerData() {
    if (!tabData[activeTabId]) {
      tabData[activeTabId] = { customer: {}, products: [] };
    }

    tabData[activeTabId].customer = {
      name: document.getElementById("customer-name").value.trim(),
      phone: document.getElementById("customer-phone").value.trim(),
      address: document.getElementById("customer-address").value.trim(),
      dob: document.getElementById("customer-dob").value.trim(),
      gender: document.getElementById("customer-gender").value.trim(),
      moneystate: document.getElementById("customer-moneystate").value.trim(),


    };

    console.log(`C·∫≠p nh·∫≠t kh√°ch h√†ng cho tab ${activeTabId}:`, tabData[activeTabId].customer);
  }

  function searchCustomer() {
    let keyword = document.getElementById("search-customer-input").value.trim();
    let customerList = document.getElementById("customer-list");

    if (keyword.length >= 1) {
      customerList.style.display = "block";
      customerList.innerHTML = "<p>ƒêang t√¨m ki·∫øm...</p>";

      fetch(`/bill/searchCustomers?keyword=${keyword}`)
              .then(response => response.json())
              .then(data => {
                if (data.length === 0) {
                  customerList.innerHTML = `<p>Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng.</p>`;
                } else {
                  customerList.innerHTML = data.map(customer => `
                        <div class="customer-item" onclick="selectCustomer(
                            '${customer.name}',
                            '${customer.phone}',
                            '${customer.address}',
                            '${customer.dob}',
                            '${customer.gender}',
                            '${customer.moneyState}'
                        )">

                            ${customer.name} - ${customer.phone}
                        </div>

                    `).join("");
                }
              })
              .catch(error => {
                console.error("L·ªói t√¨m ki·∫øm:", error);
                customerList.innerHTML = "<p>L·ªói khi t√¨m ki·∫øm</p>";
              });
    } else {
      customerList.innerHTML = "";
      customerList.style.display = "none";
    }
  }

  // Ch·ªçn kh√°ch h√†ng t·ª´ danh s√°ch
  function selectCustomer(name, phone, address,dob,gender,moneystate) {
    document.getElementById("customer-name").value = name;
    document.getElementById("customer-phone").value = phone;
    document.getElementById("customer-address").value = address;
    document.getElementById("customer-dob").value = dob;
    document.getElementById("customer-gender").value = gender;
    document.getElementById("customer-moneystate").value = moneystate;
    console.log(gender)
    if (!tabData[activeTabId]) {
      tabData[activeTabId] = { customer: {}, products: [] };
    }

    // L∆∞u t√™n kh√°ch h√†ng ban ƒë·∫ßu
    tabData[activeTabId].originalCustomerName = name;

    tabData[activeTabId].customer = { name, phone, address ,dob,gender ,moneystate };
    // ƒê·∫∑t readonly
    document.getElementById("customer-name").readOnly = true;
    document.getElementById("customer-phone").readOnly = true;
    document.getElementById("customer-address").readOnly = true;
    document.getElementById("customer-dob").readOnly = true;
    document.getElementById("customer-gender").readOnly = true;
    document.getElementById("customer-moneystate").readOnly = true;

    // ƒê√≥ng popup
    closeCustomerSearchModal();
  }
  document.getElementById("save-customer-btn").addEventListener("click", function () {
    let name = document.getElementById("new-customer-name").value.trim();
    let phone = document.getElementById("new-customer-phone").value.trim();
    let address = document.getElementById("new-customer-address").value.trim();
    let dob = document.getElementById("new-customer-dob").value.trim();
    let gender = document.getElementById("new-customer-gender").value.trim();
    if (!name || !phone || !address) {
      alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng!");
      return;
    }

    let requestData = {
      name: name,
      phone: phone,
      address: address,
      dob: dob,
      gender: gender
    };

    fetch("/bill/addCustomer", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(requestData)
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert("Th√™m kh√°ch h√†ng th√†nh c√¥ng!");


                closeAddCustomerModal();
              } else {
                alert("L·ªói khi th√™m kh√°ch h√†ng: " + data.message);
              }
            })
            .catch(error => {
              console.error("L·ªói g·ª≠i d·ªØ li·ªáu:", error);
              alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu.");
            });
  });

  function renderProducts(tabId) {
    let productTable = document.getElementById("selected-products");
    productTable.innerHTML = "";

    if (!tabData[tabId] || !Array.isArray(tabData[tabId].products)) {
      tabData[tabId] = { customer: {}, products: [] }; // ƒê·∫£m b·∫£o c√≥ m·∫£ng products
    }

    tabData[tabId].products.forEach((product, index) => {
      let row = `
            <tr id="product-${product.id}">
                <td>${index + 1}</td>
                <td>${product.name}</td>
                <td class="quantity-cell">
                    <span class="quantity-value">${product.quantity}</span>
                    <div class="quantity-controls">
                        <div class="quantity-btn minus" onclick="changeQuantity('${tabId}', ${product.id}, -1)">-</div>
                        <div class="quantity-btn plus" onclick="changeQuantity('${tabId}', ${product.id}, 1)">+</div>
                    </div>
                </td>
                <td class="price-cell">${formatPrice(product.price)}</td>
                <td class="price-cell total-price">${formatPrice(product.price * product.quantity)}</td>
                <td><button onclick="removeProduct('${tabId}', ${product.id})">‚úñ</button></td>
            </tr>
        `;
      productTable.insertAdjacentHTML("beforeend", row);
    });
  }

  function changeQuantity(tabId, id, change) {
    let product = tabData[tabId].products.find(p => p.id === id);
    console.log(product)
    if (!product) return;

    product.quantity = Math.max(1, product.quantity + change);

    renderProducts(tabId);
    updateOrderTotal(tabId);
  }

  function removeProduct(tabId, id) {
    if (!tabData[tabId] || !Array.isArray(tabData[tabId].products)) return;
    tabData[tabId] = tabData[tabId].products.filter(p => p.id !== id);
    renderProducts(tabId);
    updateOrderTotal(tabId);
  }

  document.getElementById("loading").addEventListener("change", function () {
    let loadingAmountInput = document.getElementById("loading-amount");
    console.log(loadingAmountInput);
    if (this.checked) {
      loadingAmountInput.removeAttribute("readonly"); // Cho ph√©p nh·∫≠p ti·ªÅn b·ªëc h√†ng
    } else {
      loadingAmountInput.setAttribute("readonly", true); // Kh√¥ng cho ph√©p nh·∫≠p
      loadingAmountInput.value = "0"; // ƒê·∫∑t l·∫°i v·ªÅ 0 khi b·ªè ch·ªçn
    }

    updateOrderTotal(activeTabId);
  });

  // Khi ch·ªçn "Tr·∫£ h·∫øt", ·∫©n √¥ nh·∫≠p ti·ªÅn tr·∫£ n·ª£ v√† c·∫≠p nh·∫≠t s·ªë ti·ªÅn kh√°ch thanh to√°n = t·ªïng ti·ªÅn
  document.getElementById("pay-all").addEventListener("change", function () {
    if (this.checked) {
      let totalAmount = parsePrice(document.getElementById("customer-pay").textContent);
      document.getElementById("display-payment-amount").textContent = formatPrice(totalAmount);

      document.getElementById("debt-payment-container").style.display = "none"; // ·∫®n √¥ nh·∫≠p s·ªë ti·ªÅn tr·∫£ n·ª£
    }
  });

  // Khi ch·ªçn "Tr·∫£ n·ª£", hi·ªÉn th·ªã √¥ nh·∫≠p ti·ªÅn tr·∫£ n·ª£ v√† c·∫≠p nh·∫≠t s·ªë ti·ªÅn kh√°ch thanh to√°n
  document.getElementById("pay-rent").addEventListener("change", function () {
    if (this.checked) {
      document.getElementById("debt-payment-container").style.display = "block"; // Hi·ªÉn th·ªã √¥ nh·∫≠p s·ªë ti·ªÅn tr·∫£ n·ª£
      updatePaymentAmount(); // C·∫≠p nh·∫≠t s·ªë ti·ªÅn kh√°ch thanh to√°n
    }
  });

  // Khi nh·∫≠p s·ªë ti·ªÅn tr·∫£ n·ª£, c·∫≠p nh·∫≠t s·ªë ti·ªÅn kh√°ch thanh to√°n
  document.getElementById("debt-payment-amount").addEventListener("input", function () {
    updatePaymentAmount();
  });

  // H√†m c·∫≠p nh·∫≠t t·ªïng ti·ªÅn kh√°ch thanh to√°n
  function updatePaymentAmount() {
    let totalAmount = parsePrice(document.getElementById("customer-pay").textContent);
    let debtPayment = parsePrice(document.getElementById("debt-payment-amount").value);

    if (document.getElementById("pay-rent").checked) {
      document.getElementById("display-payment-amount").textContent = formatPrice(totalAmount + debtPayment);
    }
  }

  function updateOrderTotal(tabId) {
    let productTotal = 0; // M·∫∑c ƒë·ªãnh t·ªïng ti·ªÅn s·∫£n ph·∫©m l√† 0 n·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
    if (tabData[activeTabId] && tabData[activeTabId].products) {
      productTotal = tabData[activeTabId].products.reduce((sum, product) => sum + product.price * product.quantity, 0);
    }

    // L·∫•y ti·ªÅn b·ªëc h√†ng n·∫øu checkbox "B·ªëc h√†ng" ƒë∆∞·ª£c ch·ªçn
    let loadingFee = document.getElementById("loading").checked ? parsePrice(document.getElementById("loading-amount").value) : 0;

    let finalTotal = productTotal + loadingFee;

    document.getElementById("total-amount").textContent = formatPrice(finalTotal);
    document.getElementById("customer-pay").textContent = formatPrice(finalTotal);
    // N·∫øu ƒëang ch·ªçn "Tr·∫£ h·∫øt", c·∫≠p nh·∫≠t l·∫°i s·ªë ti·ªÅn kh√°ch thanh to√°n
    if (document.getElementById("pay-all").checked) {
      document.getElementById("display-payment-amount").textContent = formatPrice(finalTotal);
    } else {
      updatePaymentAmount(); // N·∫øu ch·ªçn "Tr·∫£ n·ª£", c·∫≠p nh·∫≠t theo s·ªë ti·ªÅn nh·∫≠p
    }
  }
  // G√°n s·ª± ki·ªán khi nh·∫≠p ti·ªÅn b·ªëc h√†ng s·∫Ω c·∫≠p nh·∫≠t t·ªïng ti·ªÅn ngay l·∫≠p t·ª©c
  document.getElementById("loading-amount").addEventListener("input", function () {
    if (document.getElementById("loading").checked) {
      updateOrderTotal(); // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn ngay khi nh·∫≠p gi√° tr·ªã
    }
  });

  // X·ª≠ l√Ω t·∫°o v√† chuy·ªÉn tab
  document.querySelector(".add-tab").addEventListener("click", function () {
    let existingNumbers = [...document.querySelectorAll(".tab")]
            .map(tab => parseInt(tab.querySelector(".tab-title").textContent.replace("H√≥a ƒë∆°n ", "")))
            .filter(n => !isNaN(n)); // L·∫•y danh s√°ch c√°c s·ªë h√≥a ƒë∆°n hi·ªán t·∫°i

    let newNumber = 1;
    while (existingNumbers.includes(newNumber)) {
      newNumber++; // T√¨m s·ªë nh·ªè nh·∫•t ch∆∞a ƒë∆∞·ª£c d√πng
    }
    let tabId = `tab-${Date.now()}`; // S·ª≠ d·ª•ng timestamp ƒë·ªÉ t·∫°o ID duy nh·∫•t
    tabData[tabId] = { customer: {}, products: [] }; // ƒê√∫ng c√∫ ph√°p

    let newTab = document.createElement("div");
    newTab.className = "tab";
    newTab.setAttribute("data-tab", tabId);
    newTab.innerHTML = `
        <span class="tab-title">H√≥a ƒë∆°n ${newNumber}</span>
        <span class="tab-close">√ó</span>
    `;

    newTab.addEventListener("click", function () {
      switchTab(tabId);
    });

    newTab.querySelector(".tab-close").addEventListener("click", function (e) {
      e.stopPropagation();
      delete tabData[tabId];
      newTab.remove();
      if (document.querySelectorAll(".tab").length > 0) {
        let firstTab = document.querySelector(".tab");
        switchTab(firstTab.getAttribute("data-tab"));
      }
    });

    // ‚úÖ Ch√®n tab v√†o ƒë√∫ng v·ªã tr√≠ thay v√¨ ch·ªâ ƒë·∫∑t tr∆∞·ªõc d·∫•u +
    let tabContainer = document.querySelector(".tab-container");
    let tabs = [...tabContainer.querySelectorAll(".tab")];

    let inserted = false;
    for (let tab of tabs) {
      let tabNumber = parseInt(tab.querySelector(".tab-title").textContent.replace("H√≥a ƒë∆°n ", ""));
      if (newNumber < tabNumber) {
        tabContainer.insertBefore(newTab, tab);
        inserted = true;
        break;
      }
    }

    if (!inserted) {
      tabContainer.insertBefore(newTab, document.querySelector(".add-tab"));
    }

    switchTab(tabId);
  });

  function switchTab(tabId) {
    savePaymentData(activeTabId);
    console.log(tabData[activeTabId]?.payment.method);
    // N·∫øu tab ch∆∞a c√≥ d·ªØ li·ªáu, kh·ªüi t·∫°o m·ªõi

    activeTabId = tabId;
    document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
    document.querySelector(`[data-tab="${tabId}"]`).classList.add("active");

    if (!tabData[tabId]) {
      tabData[tabId] = { customer: {}, products: [], payment: { method: "pay-all", loading: false, debtAmount: 0, loadingAmount: 0 } };
    }

    renderProducts(tabId);
    updateOrderTotal(tabId);

    // Reset v√† c·∫≠p nh·∫≠t l·ª±a ch·ªçn thanh to√°n
    loadPaymentData(tabId);

    // Reset th√¥ng tin kh√°ch h√†ng khi chuy·ªÉn tab
    loadCustomerData(tabId);
  }

  function savePaymentData(tabId) {
    if (!tabData[tabId]) {
      tabData[tabId] = { customer: {}, products: [], payment: {} }; // Kh·ªüi t·∫°o n·∫øu ch∆∞a c√≥
    }

    tabData[tabId].payment = {
      method: document.getElementById("pay-all").checked ? "pay-all" : "pay-rent",
      debtAmount: parsePrice(document.getElementById("debt-payment-amount").value),
      loading: document.getElementById("loading").checked,
      loadingAmount: parsePrice(document.getElementById("loading-amount").value)
    };
  }



  function loadPaymentData(tabId) {
    let paymentData = tabData[tabId]?.payment || { method: "pay-all", loading: false, debtAmount: 0, loadingAmount: 0 };

    // Reset l·∫°i radio button v√† checkbox
    console.log(paymentData.method);
    document.getElementById("pay-all").checked = paymentData.method === "pay-all";
    document.getElementById("pay-rent").checked = paymentData.method === "pay-rent";
    document.getElementById("loading").checked = paymentData.loading;

    // Hi·ªÉn th·ªã ho·∫∑c ·∫©n √¥ nh·∫≠p ti·ªÅn tr·∫£ n·ª£
    document.getElementById("debt-payment-container").style.display = paymentData.method === "pay-rent" ? "block" : "none";
    document.getElementById("debt-payment-amount").value = paymentData.debtAmount;

    // Hi·ªÉn th·ªã ti·ªÅn b·ªëc h√†ng
    let loadingAmountInput = document.getElementById("loading-amount");
    loadingAmountInput.value = paymentData.loadingAmount;
    loadingAmountInput.readOnly = !paymentData.loading;

    // ‚úÖ **C·∫≠p nh·∫≠t s·ªë ti·ªÅn kh√°ch thanh to√°n theo tab hi·ªán t·∫°i**
    let totalAmount = parsePrice(document.getElementById("customer-pay").textContent);
    let debtPayment = paymentData.debtAmount || 0;
    let finalPayment = paymentData.method === "pay-rent" ? totalAmount + debtPayment : totalAmount;
    document.getElementById("display-payment-amount").textContent = formatPrice(finalPayment);
    // C·∫≠p nh·∫≠t s·ªë ti·ªÅn kh√°ch thanh to√°n
    updatePaymentAmount(tabId);
  }


  function loadCustomerData(tabId) {
    let customer = tabData[tabId]?.customer || {};
    console.log(customer.moneystate)
    document.getElementById("customer-name").value = customer.name || "";
    document.getElementById("customer-phone").value = customer.phone || "";
    document.getElementById("customer-address").value = customer.address || "";
    document.getElementById("customer-dob").value = customer.dob || "";
    document.getElementById("customer-gender").value = customer.gender || "";
    document.getElementById("customer-moneystate").value = customer.moneystate || "";
  }

  document.querySelector(".checkout-button").addEventListener("click", function () {
    if (!tabData[activeTabId]) {
      alert("Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ thanh to√°n!");
      return;
    }

    let customerData = tabData[activeTabId]?.customer || {};
    let productData = tabData[activeTabId]?.products || [];

    if (!customerData.name || productData.length === 0) {
      alert("Vui l√≤ng nh·∫≠p th√¥ng tin kh√°ch h√†ng v√† th√™m s·∫£n ph·∫©m!");
      return;
    }

    let requestData = {
      customer: customerData,
      products: productData
    };

    fetch("/bill/submitBill", {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(requestData)
    })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                alert("Thanh to√°n th√†nh c√¥ng!");
                removeTab(activeTabId); // X√≥a tab ƒë√£ x·ª≠ l√Ω
              } else {
                alert("L·ªói khi x·ª≠ l√Ω thanh to√°n: " + data.message);
              }
            })
            .catch(error => {
              console.error("L·ªói g·ª≠i d·ªØ li·ªáu:", error);
              alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu.");
            });
  });
</script>


</body>
</html>