<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω b√°n h√†ng</title>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="icon" type="image/x-icon" th:href="@{/images/account.jpg}">
  <style>
    .search-container {
      background: white;
      border-radius: 3px;
      display: flex;
      align-items: center;
      margin-left: 15px;
      padding: 0 8px;
      width: 240px;
      margin-bottom: 20px;
    }
    .search-container input {
      border: none;
      padding: 6px;
      outline: none;
      width: 100%;
    }
    .search-icon {
      color: #666;
    }.tab-container {
       background-color: #f9f9f9;
       display: flex;
       align-items: center;
       border-bottom: 1px solid #ddd;
       overflow-x: auto;
       white-space: nowrap;
     }
    .tab {
      display: inline-flex;
      align-items: center;
      padding: 8px 20px 8px 15px;
      background-color: #f1f1f1;
      border-right: 1px solid #ddd;
      cursor: pointer;
      position: relative;
      min-width: 150px;
      max-width: 220px;
    }
    .tab.active {
      background-color: white;
      border-bottom: 2px solid #2c5aa9;
    }
    .tab-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1;
    }
    .tab-close {
      margin-left: 8px;
      width: 16px;
      height: 16px;
      line-height: 14px;
      text-align: center;
      border-radius: 50%;
    }
    .tab-close:hover {
      background-color: #ddd;
    }
    .add-tab {
      padding: 8px 15px;
      cursor: pointer;
      font-size: 18px;
      background-color: transparent;
      border: none;
    }
    .main-container {
      display: flex;
      margin: 20px;
      gap: 20px;
      height: calc(100vh - 180px);
    }
    .left-panel {
      flex: 3;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      max-height: 100%;
    }
    .right-panel {
      flex: 1;
      background-color: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      padding: 15px;
      max-height: 100%;
      overflow-y: auto;
      min-width: 300px;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      padding: 15px;
      align-items: center;
      border-bottom: 1px solid #eee;
    }
    .toolbar-left {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .toolbar-right {
      display: flex;
      gap: 15px;
      align-items: center;
    }
    .products-container {
      flex: 1;
      overflow-y: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      padding: 10px 15px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    th {
      font-weight: 500;
      color: #333;
      background-color: #f9f9f9;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    tr:hover {background-color: #f5f5f5;
    }
    .quantity-cell {
      text-align: center;
      position: relative;
    }
    .quantity-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-radius: 3px;
      display: none;
    }
    .quantity-cell:hover .quantity-controls {
      display: flex;
    }
    .quantity-btn {
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }
    .quantity-btn:hover {
      background-color: #eee;
    }
    .quantity-btn.minus {
      border-right: 1px solid #ddd;
    }
    .price-cell {
      text-align: right;
    }
    .add-product {
      display: flex;
      padding: 15px;
      border-top: 1px solid #eee;
      color: #999;
      font-style: italic;
      cursor: pointer;
    }
    .add-product:hover {
      background-color: #f9f9f9;
    }
    /* ƒê·ªãnh d·∫°ng modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }

    /* N·ªôi dung modal */
    .modal-content {
      background: white;
      padding: 20px;
      width: 50%;
      max-width: 600px;
      border-radius: 8px;
      box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.3);
      position: relative;
    }

    /* N√∫t ƒë√≥ng modal */
    .close {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
    }

    /* Input t√¨m ki·∫øm */
    .styled-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      margin-bottom: 10px;
    }

    /* Danh s√°ch s·∫£n ph·∫©m */
    .product-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      background: white;
    }

    /* M·ªói s·∫£n ph·∫©m */
    .product-item {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
    }

    .product-item:hover {
      background: #f1f1f1;
    }

    .customer-list {
      position: absolute;
      background: white;
      border: 1px solid #ddd;
      max-height: 200px;
      overflow-y: auto;
      width: 280px;
      box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.2);
      display: none;
    }

    .customer-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #ddd;
    }

    .customer-item:hover {
      background: #f1f1f1;
    }


    .checkout-button {
      background-color: #3480e3;
      color: white;
      border: none;
      padding: 12px 30px;
      font-weight: 500;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
      margin-top: 20px;
      text-align: center;
    }

    .section {
      margin-bottom: 20px;
      border: 1px solid #eee;
      border-radius: 4px;
    }
    .section-header {
      padding: 10px 15px;
      background-color: #f9f9f9;
      border-bottom: 1px solid #eee;
      font-weight: 500;
    }
    .section-content {
      padding: 15px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-size: 14px;
      color: #666;
    }
    .form-control {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    .total-row:last-child {
      border-bottom: none;
    }
    .total-label {
      color: #666;
    }
    .total-value {
      font-weight: 500;
    }
    .total-value.highlight {
      color: #e74c3c;
      font-weight: bold;
    }
    .payment-methods {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
    }
    .payment-method {
      flex: 1;
      min-width: 80px;
      display: flex;
      align-items: center;
    }
  </style>
  <script src="/js/home.js"></script>

</head>
<body>
<!-- Header -->
<div class="header">
  <button class="menu-btn" onclick="toggleSidebar()">‚ò∞</button>
  <h2><a href="/home">RSMS</a></h2>
  <div class="user-info">
    <img  th:src="${user.avatar}" alt="User Avatar" class="user-avatar"/>
    <div class="dropdown">
      <span th:text="${account.displayName}" class="user-name" onclick="toggleDropdown()"> ‚ñº</span>
      <div id="dropdown-menu" class="dropdown-content">
        <a href="/user/userprofile">üë§ View Profile</a>
        <a href="/user/changepw" id="changepw">üîë Change password</a>
        <a href="/static#" id="logout">üö™ Logout</a>

      </div>
    </div>
  </div>

</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar" style="height: 100%;">
  <h2>Feature</h2>
  <a href="/user/userprofile">Profile</a>
  <a href="/account/listStaff" th:style="${#lists.contains(listHiddenPage, 'listStaff')} ? 'display: none;' : ''">Staff Account Management</a>
  <a href="/product/listProduct">Rice Management</a>
  <a href="/customer/listCustomer">Customer Management</a>
  <a href="/warehouse/listWarehouseZone">Warehouse Management</a>
  <a href="/bill/listBill">Invoice Management</a>
</div>
<div class="content">
<!--<div class="search-container">-->
<!--  <span class="search-icon">üîç</span>-->
<!--  <input type="text" placeholder="T√¨m ki·∫øm theo m√£">-->
<!--</div>-->
  <div class="tab-container">
    <div class="tab active" data-tab="tab-1" onclick="switchTab('tab-1')">
      <span class="tab-title">H√≥a ƒë∆°n 1</span>
      <span class="tab-close">√ó</span>
    </div>
    <button class="add-tab">+</button>
  </div>


<div class="main-container">
  <div class="left-panel">
    <!-- N√∫t th√™m s·∫£n ph·∫©m (ban ƒë·∫ßu hi·ªÉn th·ªã) -->
    <div class="add-product" id="add-product" onclick="showProductModal()">
      <span>+ T√™n s·∫£n ph·∫©m</span>
    </div>

    <!-- Modal ch·ª©a danh s√°ch s·∫£n ph·∫©m -->
    <div id="product-modal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeProductModal()">&times;</span>
        <h2>Ch·ªçn s·∫£n ph·∫©m</h2>

        <!-- √î t√¨m ki·∫øm s·∫£n ph·∫©m -->
        <input type="text" id="search-product" class="styled-input" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." onkeyup="searchProduct()">

        <!-- Danh s√°ch s·∫£n ph·∫©m -->
        <div id="product-list" class="product-list">
          <p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>
        </div>
      </div>
    </div>


    <div class="products-container">
      <table>
        <thead>
        <tr>
          <th>#</th>
          <th>S·∫£n ph·∫©m</th>
          <th class="quantity-cell">SL</th>
          <th class="price-cell">ƒê∆°n gi√°</th>
          <th class="price-cell">Th√†nh ti·ªÅn</th>
          <th>X√≥a</th>
        </tr>
        </thead>
        <tbody id="selected-products">
        <!-- C√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
        </tbody>
      </table>

    </div>



  </div>

  <div class="right-panel">
    <div class="section">
      <div class="section-header">Th√¥ng tin kh√°ch h√†ng</div>
      <div class="section-content">
        <div class="form-group">
          <label>Kh√°ch h√†ng</label>
          <input type="text" class="form-control" id="customer-search" onkeyup="searchCustomer()"  placeholder="Nh·∫≠p t√™n kh√°ch h√†ng">
          <div id="customer-list" class="customer-list"></div>
        </div>
        <div class="form-group">
          <label>ƒê·ªãa ch·ªâ</label>
          <input type="text" class="form-control" id="customer-address" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ kh√°ch h√†ng" readonly>
        </div>
        <div class="form-group">
          <label>S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="text" class="form-control" id="customer-phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" readonly>
        </div>
        <div class="form-group">
          <label>N·ª£ c≈©</label>
          <input type="text" class="form-control" placeholder="N·ª£ c≈©" readonly>
        </div>
        <div class="form-group">
          <label>T·ªïng c√¥n n·ª£</label>
          <input type="text" class="form-control" placeholder="T·ªïng c√¥n n·ª£" readonly>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">T·ªïng c·ªông</div>
      <div class="section-content">
        <div class="total-row">
          <span class="total-label">T·ªïng ti·ªÅn h√†ng:</span>
          <span class="total-value" id="total-amount">0</span>
        </div>
        <div class="total-row">
          <span class="total-label">Kh√°ch c·∫ßn tr·∫£:</span>
          <span class="total-value highlight" id="customer-pay">0</span>
        </div>
      </div>
    </div>

    <div class="section">
      <div class="section-header">Thanh to√°n</div>
      <div class="section-content">
        <div class="total-row">
          <span class="total-label">Kh√°ch thanh to√°n:</span>
          <span class="total-value" id="payment-amount">13,815,000</span>
        </div>

        <div class="payment-methods">
          <div class="payment-method">
            <input type="radio" name="payment" id="pay-all">
            <label for="pay-all">Tr·∫£ h·∫øt</label>
          </div>
          <div class="payment-method">
            <input type="radio" name="payment" id="pay-rent">
            <label for="pay-rent">Tr·∫£ n·ª£</label>
          </div>
          <div class="payment-method">
            <input type="checkbox" name="payment" id="loading">
            <label for="loading">B·ªëc h√†ng</label>
          </div>
        </div>

        <div class="payment-amount">
          <div>Ti·ªÅn b·ªëc h√†ng:</div>
          <input type="text" class="form-control payment-input" id="loading-amount" value="0">
        </div>

        <button class="checkout-button">THANH TO√ÅN</button>
      </div>
    </div>
  </div>
</div>

</div>
<footer>
  &copy; 2025 Rice Sales Management. All Rights Reserved.
</footer>

<script>
  let tabData = {}; // L∆∞u d·ªØ li·ªáu cho t·ª´ng tab
  let activeTabId = "tab-1"; // ID c·ªßa tab ƒëang ƒë∆∞·ª£c ch·ªçn

  function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN').format(price);
  }

  function parsePrice(priceStr) {
    return parseInt(priceStr.replace(/[,.]/g, '')) || 0;
  }

  function showProductModal() {
    document.getElementById("product-modal").style.display = "flex";
  }

  function closeProductModal() {
    document.getElementById("product-modal").style.display = "none";
  }

  /* H√†m t√¨m ki·∫øm s·∫£n ph·∫©m */
  function searchProduct() {
    let keyword = document.getElementById("search-product").value;
    let productList = document.getElementById("product-list");
    if (keyword.length >= 1) {

      fetch(`/bill/searchProducts?keyword=${keyword}`)
              .then(response => response.json())
              .then(data => {
                if (data.length === 0) {
                  productList.innerHTML = "<p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</p>"; // N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£
                } else {
                  productList.innerHTML = data.map(product => `
                        <div class="product-item" onclick="selectProduct(${product.id}, '${product.name}', ${product.price})">
                            ${product.name} - ${product.price} VND
                        </div>
                    `).join(""); // T·∫°o danh s√°ch s·∫£n ph·∫©m m·ªõi
                }
              })
              .catch(error => console.error("L·ªói t√¨m ki·∫øm:", error));
    } else {
      document.getElementById("product-list").innerHTML = "<p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>";
    }
  }


  /* Khi ch·ªçn s·∫£n ph·∫©m, th√™m v√†o h√≥a ƒë∆°n v√† ƒë√≥ng modal */
  function selectProduct(id, name, price) {
    if (!tabData[activeTabId]) tabData[activeTabId] = [];

    let existingProduct = tabData[activeTabId].find(p => p.id === id);
    if (existingProduct) {
      alert("S·∫£n ph·∫©m n√†y ƒë√£ ƒë∆∞·ª£c th√™m v√†o tab n√†y!");
      return;
    }

    tabData[activeTabId].push({ id, name, price, quantity: 1 });
    document.getElementById("search-product").value = ""; // X√≥a n·ªôi dung t√¨m ki·∫øm
    document.getElementById("product-list").innerHTML = "<p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>";
    renderProducts(activeTabId);
    updateOrderTotal(activeTabId);

    closeProductModal(); // ƒê√≥ng modal sau khi ch·ªçn s·∫£n ph·∫©m
  }

  document.getElementById("customer-search").addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
      event.preventDefault(); // NgƒÉn ch·∫∑n reload trang

      let customerList = document.getElementById("customer-list").children;
      if (customerList.length > 0) {
        // N·∫øu danh s√°ch c√≥ kh√°ch h√†ng, ch·ªçn kh√°ch h√†ng ƒë·∫ßu ti√™n
        customerList[0].click();
      } else {
        // N·∫øu kh√¥ng c√≥ kh√°ch h√†ng, m·ªü kh√≥a nh·∫≠p th√¥ng tin m·ªõi
        resetCustomerFields();
      }
    }
  });

  function searchCustomer() {
    let keyword = document.getElementById("customer-search").value.trim();
    let customerList = document.getElementById("customer-list");

    if (keyword.length >= 1) {
      customerList.style.display = "block";
      customerList.innerHTML = "<p>ƒêang t√¨m ki·∫øm...</p>";

      fetch(`/bill/searchCustomers?keyword=${keyword}`)
              .then(response => response.json())
              .then(data => {
                if (data.length === 0) {
                  customerList.innerHTML = `<p>Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng. Nh·∫•n Enter ƒë·ªÉ th√™m m·ªõi</p>`;
                  resetCustomerFields(); // Cho ph√©p nh·∫≠p m·ªõi
                } else {
                  customerList.innerHTML = data.map(customer => `
                        <div class="customer-item" onclick="selectCustomer(
                            '${customer.name || ''}',
                            '${customer.phone || ''}',
                            '${customer.address || ''}',
                            true
                        )">
                            ${customer.name || 'Kh√¥ng c√≥ t√™n'} - ${customer.phone || 'Kh√¥ng c√≥ s·ªë ƒëi·ªán tho·∫°i'}
                        </div>
                    `).join("");

                }
              })
              .catch(error => {
                console.error("L·ªói t√¨m ki·∫øm:", error);
                customerList.innerHTML = "<p>L·ªói khi t√¨m ki·∫øm</p>";
              });
    } else {
      customerList.innerHTML = "";
      customerList.style.display = "none";
      resetCustomerFields(); // Cho ph√©p nh·∫≠p m·ªõi khi kh√¥ng t√¨m th·∫•y kh√°ch h√†ng
    }
  }

  function selectCustomer(name, phone, address) {

    if (!tabData[activeTabId]) {
      tabData[activeTabId] = { customer: {}, products: [] };
    }

    tabData[activeTabId].customer = {
      name,
      phone,
      address
    };
    let customerList = document.getElementById("customer-list");
    document.getElementById("customer-search").value = name;
    document.getElementById("customer-phone").value = phone;
    document.getElementById("customer-address").value = address;
    customerList.innerHTML = "";
    customerList.style.display = "none";
    if (exists) {
      // N·∫øu kh√°ch h√†ng ƒë√£ t·ªìn t·∫°i, kh√≥a c√°c √¥ nh·∫≠p
      document.getElementById("customer-phone").readOnly = true;
      document.getElementById("customer-address").readOnly = true;

    } else {
      // N·∫øu l√† kh√°ch h√†ng m·ªõi, m·ªü kh√≥a ƒë·ªÉ nh·∫≠p th√¥ng tin
      document.getElementById("customer-phone").readOnly = false;
      document.getElementById("customer-address").readOnly = false;
    }

    document.getElementById("customer-list").style.display = "none"; // ·∫®n danh s√°ch g·ª£i √Ω sau khi ch·ªçn
  }

  // X√≥a d·ªØ li·ªáu c≈© v√† m·ªü kh√≥a nh·∫≠p li·ªáu n·∫øu kh√°ch h√†ng ch∆∞a c√≥
  function resetCustomerFields() {
    document.getElementById("customer-phone").value = "";
    document.getElementById("customer-address").value = "";
    let customerList = document.getElementById("customer-list");
    customerList.innerHTML = "";
    customerList.style.display = "none";
    document.getElementById("customer-phone").readOnly = false;
    document.getElementById("customer-address").readOnly = false;
  }

  function renderProducts(tabId) {
    let productTable = document.getElementById("selected-products");
    productTable.innerHTML = "";

    tabData[tabId].forEach((product, index) => {
      let row = `
            <tr id="product-${product.id}">
                <td>${index + 1}</td>
                <td>${product.name}</td>
                <td class="quantity-cell">
                    <span class="quantity-value">${product.quantity}</span>
                    <div class="quantity-controls">
                        <div class="quantity-btn minus" onclick="changeQuantity('${tabId}', ${product.id}, -1)">-</div>
                        <div class="quantity-btn plus" onclick="changeQuantity('${tabId}', ${product.id}, 1)">+</div>
                    </div>
                </td>
                <td class="price-cell">${formatPrice(product.price)}</td>
                <td class="price-cell total-price">${formatPrice(product.price * product.quantity)}</td>
                <td><button onclick="removeProduct('${tabId}', ${product.id})">‚úñ</button></td>
            </tr>
        `;
      productTable.insertAdjacentHTML("beforeend", row);
    });
  }

  function changeQuantity(tabId, id, change) {
    let product = tabData[tabId].find(p => p.id === id);
    if (!product) return;

    product.quantity = Math.max(1, product.quantity + change);

    renderProducts(tabId);
    updateOrderTotal(tabId);
  }

  function removeProduct(tabId, id) {
    tabData[tabId] = tabData[tabId].filter(p => p.id !== id);
    renderProducts(tabId);
    updateOrderTotal(tabId);
  }

  function updateOrderTotal(tabId) {
    let total = tabData[tabId].reduce((sum, product) => sum + product.price * product.quantity, 0);
    document.getElementById("total-amount").textContent = formatPrice(total);
    document.getElementById("customer-pay").textContent = formatPrice(total);
  }

  // X·ª≠ l√Ω t·∫°o v√† chuy·ªÉn tab
  document.querySelector(".add-tab").addEventListener("click", function () {
    let tabCount = document.querySelectorAll(".tab").length + 1;
    let tabId = `tab-${tabCount}`;
    tabData[tabId] = [];

    let newTab = document.createElement("div");
    newTab.className = "tab";
    newTab.setAttribute("data-tab", tabId);
    newTab.innerHTML = `
        <span class="tab-title">H√≥a ƒë∆°n ${tabCount}</span>
        <span class="tab-close">√ó</span>
    `;

    newTab.addEventListener("click", function () {
      switchTab(tabId);
    });

    newTab.querySelector(".tab-close").addEventListener("click", function (e) {
      e.stopPropagation();
      delete tabData[tabId];
      newTab.remove();
      if (document.querySelectorAll(".tab").length > 0) {
        let firstTab = document.querySelector(".tab");
        switchTab(firstTab.getAttribute("data-tab"));
      }
    });

    document.querySelector(".tab-container").insertBefore(newTab, this);
    switchTab(tabId);
  });

  function switchTab(tabId) {
    activeTabId = tabId;
    document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
    document.querySelector(`[data-tab="${tabId}"]`).classList.add("active");

    renderProducts(tabId);
    updateOrderTotal(tabId);
    // Reset th√¥ng tin kh√°ch h√†ng khi chuy·ªÉn tab
  }
</script>


</body>
</html>