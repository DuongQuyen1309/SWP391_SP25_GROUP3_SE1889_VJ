<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Bill</title>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/bill.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="icon" type="image/x-icon" th:href="@{/images/account.jpg}">

  <script src="/js/home.js"></script>
  <style>
    .form-row {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }

    .form-row label {
      margin-bottom: 5px;
      font-weight: 600;
    }

    .styled-input {
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .form-row.center {
      text-align: center;
    }

    .btn-save {
      background-color: #2c3e50;
      color: white;
      padding: 10px 25px;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      cursor: pointer;
      transition: background-color 0.3s;
    }


  </style>

  <script>

    document.addEventListener("DOMContentLoaded", function () {
      var nameRegex = /^[a-zA-Z√Ä-·ª∏√†-·ªπ\s]+$/;
      var today = new Date().toISOString().split("T")[0];
      const form = document.querySelector(".create-form");
      const customerNameInput = document.getElementById("new-customer-name");
      const customerPhoneInput = document.getElementById("new-customer-phone");
      const customerAddressInput = document.getElementById("new-customer-address");
      const CustomerDobInput = document.getElementById("new-customer-dob");
      const customerGenderInput= document.getElementById("new-customer-gender");

      async function checkPhoneExists(phone) {
        try {
          let response = await fetch(`/api/check-phone-customer?phone=${phone}`);
          let data = await response.json();
          return data.exists;
        } catch (error) {
          console.error("Error when checking phone:", error);
          return false;
        }
      }

      form.addEventListener("submit", async function (event) {
        event.preventDefault();
        let hasError = false;
        // X√≥a l·ªói c≈© tr∆∞·ªõc khi ki·ªÉm tra l·∫°i
        document.querySelectorAll('.error-message').forEach(el => el.textContent = "");
// Ki·ªÉm tra name
        if (customerNameInput.value.length < 5) {
          document.getElementById("name-error").textContent = "T√™n ƒë·∫ßy ƒë·ªß ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng 5 k√≠ t·ª±";
          document.getElementById("name-error").style.display = "block";
          hasError=true;
        } else if (!customerNameInput.value.match(nameRegex)) {
          document.getElementById("name-error").textContent = "T√™n ƒë·∫ßy ƒë·ªß kh√¥ng ƒë∆∞·ª£c ch·ª©a s·ªë ho·∫∑c k√≠ t·ª± ƒë·∫∑c bi·ªát.";
          document.getElementById("name-error").style.display = "block";
          hasError=true;
        } else if (customerNameInput.value.length > 50) {
          document.getElementById("name-error").textContent = "T√™n ƒë·∫ßy ƒë·ªß ch·ªâ c√≥ 50 ch·ªØ c√°i.";
          document.getElementById("name-error").style.display = "block";
          hasError=true;
        }

        // Ki·ªÉm tra Address
        if (customerAddressInput.value.length < 5) {
          document.getElementById("address-error").textContent = "ƒê·ªãa ch·ªâ ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng 5 k√≠ t·ª±.";
          document.getElementById("address-error").style.display = "block";
          hasError=true;

        }else if (customerAddressInput.value.length > 255) {
          document.getElementById("address-error").textContent = "ƒê·ªãa ch·ªâ ch·ªâ c√≥ 255 ch·ªØ c√°i.";
          document.getElementById("address-error").style.display = "block";
          hasError=true;
        }

        if (CustomerDobInput.value === "") {
          document.getElementById("dob-error").textContent = "Ng√†y sinh kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.";
          document.getElementById("dob-error").style.display = "block";
          hasError=true;
        }else if (CustomerDobInput.value > today) {
          document.getElementById("dob-error").textContent = "Ng√†y sinh ph·∫£i l√† ng√†y trong qu√° kh·ª©.";
          document.getElementById("dob-error").style.display = "block";
          hasError=true;
        }
        if (!customerPhoneInput.value || customerPhoneInput.value.length <= 0) {
          document.getElementById("phone-error").textContent = "S·ªë ƒëi·ªán tho·∫°i kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng.";
          document.getElementById("phone-error").style.display = "block";
          hasError = true;
        } else if (!/^0\d{9}$/.test(customerPhoneInput.value)) {
          document.getElementById("phone-error").textContent = "S·ªë ƒëi·ªán tho·∫°i ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng s·ªë 0 v√† c√≥ 10 ch·ªØ s·ªë.";
          document.getElementById("phone-error").style.display = "block";
          hasError = true;
        } else{
          let isPhoneExists = await checkPhoneExists(customerPhoneInput.value);
          if (isPhoneExists) {
            document.getElementById("phone-error").textContent ="S·ªë ƒëi·ªán tho·∫°i ƒë√£ t·ªìn t·∫°i.";
            hasError=true;
          }
        }

      if (hasError) {
        event.preventDefault();
        return;
      } else {
        console.log("allaa");
        let requestData = {
          name: customerNameInput.value,
          phone: customerPhoneInput.value,
          address: customerAddressInput.value,
          dob: CustomerDobInput.value,
          gender: customerGenderInput.value
        };

        fetch("/bill/addCustomer", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(requestData)
        })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    console.log("data.data");
                    Swal.fire({
                      icon: "success",
                      title: "T·∫°o th√†nh c√¥ng!",
                      text: " Th√¥ng tin kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng.",
                      backdrop: false, // ‚ùå T·∫Øt n·ªÅn m·ªù ph√≠a sau
                      confirmButtonText: "OK"
                    })


                    closeAddCustomerModal();
                  } else {
                    alert("L·ªói khi th√™m kh√°ch h√†ng: " + data.message);
                  }
                })
                .catch(error => {
                  console.error("L·ªói g·ª≠i d·ªØ li·ªáu:", error);
                  alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu.");
                });

      }

    });


    });
  </script>

</head>
<body>

<div th:insert="~{layout/header :: header}"></div>
<div class="sidebar" id="sidebar">
  <div th:insert="~{layout/sidebar :: sidebar}"></div>
</div>


<div class="content">
  <!--<div class="search-container">-->
  <!--  <span class="search-icon">üîç</span>-->
  <!--  <input type="text" placeholder="T√¨m ki·∫øm theo m√£">-->
  <!--</div>-->
  <div class="tab-container">
    <div class="tab active" data-tab="tab-1" onclick="switchTab('tab-1')">
      <span class="tab-title">H√≥a ƒë∆°n 1</span>
      <span class="tab-close">√ó</span>
    </div>
    <button class="add-tab">+</button>
  </div>

  <div id="order-status-container">
    <span id="order-status" style="display: none"></span>
  </div>

  <div class="main-container">
    <div class="left-panel">
      <!-- N√∫t th√™m s·∫£n ph·∫©m (ban ƒë·∫ßu hi·ªÉn th·ªã) -->
      <div class="add-product" id="add-product" onclick="showProductModal()">
        <span>+ Th√™m s·∫£n ph·∫©m</span>
      </div>

      <!-- Modal ch·ª©a danh s√°ch s·∫£n ph·∫©m -->
      <div id="product-modal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeProductModal()">&times;</span>
          <h2>Ch·ªçn s·∫£n ph·∫©m</h2>

          <!-- √î t√¨m ki·∫øm s·∫£n ph·∫©m -->
          <input type="text" id="search-product" style="width: 95%" class="styled-input" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..." onkeyup="searchProduct()">

          <!-- Danh s√°ch s·∫£n ph·∫©m -->
          <div id="product-list" class="product-list">
            <p>Nh·∫≠p t√™n s·∫£n ph·∫©m t√¨m ki·∫øm...</p>
          </div>
        </div>
      </div>


      <div class="products-container">
        <table>
          <thead>
          <tr>
            <th>#</th>
            <th>S·∫£n ph·∫©m</th>
            <th class="quantity-cell">ƒê√≥ng g√≥i</th>
            <th class="quantity-cell">S·ªë l∆∞·ª£ng</th>
            <th class="price-cell">Gi√° </th>
            <th class="price-cell">T·ªïng ti·ªÅn</th>
            <th>H√†nh ƒë·ªông</th>
          </tr>
          </thead>
          <tbody id="selected-products">
          <!-- C√°c s·∫£n ph·∫©m ƒë√£ ch·ªçn s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
          </tbody>
        </table>

        <div id="product-total-container" style="border-top: 2px solid #ccc; margin-top: 10px; padding-top: 10px;display: none">
          <div id="product-total-money" style="font-weight: bold; font-size: 18px; text-align: right; padding-right: 10px;">
            T·ªïng: <span id="product-total-value">0</span> VND
          </div>
        </div>


      </div>



    </div>

    <div class="right-panel">
      <div class="section">
        <div class="section-header">Th√¥ng tin kh√°ch h√†ng</div>
        <div class="section-content">
          <div class="form-group">
            <div class="customer-buttons">
              <button id="search-customer-btn">üîç T√¨m </button>
              <button id="add-customer-btn">‚ûï Th√™m</button>
            </div>
          </div>
          <div class="form-group">
            <label>T√™n kh√°ch h√†ng</label>
            <input type="text" class="form-control" id="customer-name" style="width: 90%" >
          </div>
          <div class="form-group">
            <label>ƒê·ªãa ch·ªâ</label>
            <input type="text" class="form-control" id="customer-address" style="width: 90%" >
          </div>
          <div class="form-group">
            <label>S·ªë ƒëi·ªán tho·∫°i</label>
            <input type="text" class="form-control" id="customer-phone" style="width: 90%">
          </div>
          <div class="form-group">
            <label>Gi·ªõi t√≠nh</label>
            <input type="text" class="form-control" id="customer-gender" style="width: 90%">
          </div>
          <div class="form-group">
            <label>Ng√†y sinh</label>
            <input type="text" class="form-control" id="customer-dob" style="width: 90%">
          </div>


        </div>
      </div>
      <!-- Popup t√¨m ki·∫øm kh√°ch h√†ng -->
      <div id="customer-search-modal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeCustomerSearchModal()">&times;</span>
          <h2>T√¨m ki·∫øm kh√°ch h√†ng</h2>
          <input type="text" id="search-customer-input" style="width: 95%" class="styled-input" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng..." onkeyup="searchCustomer()">
          <div id="customer-list" class="customer-list"></div>
        </div>
      </div>

      <!-- Popup th√™m kh√°ch h√†ng -->
      <div id="add-customer-modal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeAddCustomerModal()">&times;</span>
          <h2>T√™n kh√°ch h√†ng</h2>
          <form action="/bill/addCustomer"  class="create-form" method="post">
            <div class="form-row">
              <label>Customer Name</label>
              <input type="text" name="name" style="width: 95%" class="form-control styled-input" id="new-customer-name">
              <span class="error-message" id="name-error" style="display: none"></span>
            </div>
            <div class="form-row">
              <label>S·ªë ƒëi·ªán tho·∫°i</label>
              <input type="text" name="phone" style="width: 95%" class="form-control styled-input" id="new-customer-phone">
              <span class="error-message" id="phone-error" style="display: none"></span>
            </div>
            <div class="form-row">
              <label>ƒê·ªãa ch·ªâ</label>
              <input type="text" name="address" style="width: 95%" class="form-control styled-input" id="new-customer-address">
              <span class="error-message" id="address-error" style="display: none"></span>
            </div>

            <div class="form-row">
              <label>Gi·ªõi t√≠nh:</label>
              <select id="new-customer-gender" class="form-control styled-input"  style="width: 100%" name="gender">
                <option value="true" >Male</option>
                <option value="false" >Female</option>
              </select>
            </div>
            <div class="form-row">
              <label>Ng√†y sinh</label>
              <input type="date" style="width: 95%" class="form-control styled-input" id="new-customer-dob" name="dob">
              <span class="error-message" id="dob-error" style="display: none"></span>
            </div>


            <button class="btn-save"  id="save-customer-btn">T·∫°o </button>
          </form>


        </div>
      </div>



      <div class="section">
        <div class="section-header">Thanh To√°n</div>
        <div class="section-content">


          <div class="total-row" style="display:block">
            <span class="total-label" >Kh√°ch tr·∫£ ti·ªÅn:</span>
            <input type="text" style="width: 90%; margin-top: 5px" class="form-control" id="customer-payment" placeholder="Nh·∫≠p s·ªë ti·ªÅn kh√°ch tr·∫£" >
            <span id="customer-payment-error" class="error-message"></span>
          </div>


          <div class="total-row" style="display:block">
            <span class="total-label" >Gi·∫£m gi√°:</span>
            <input type="text" style="width: 90%; margin-top: 5px" class="form-control" id="discount" placeholder="Nh·∫≠p gi·∫£m gi√°" >
            <span id="discount-error" class="error-message"></span>
          </div>



          <div class="payment-method" style="margin-top: 10px">
            <input type="checkbox" name="payment" id="loading">
            <label for="loading" class="total-label">B·ªëc v√°c</label>
          </div>

          <div class="total-row" style="display: block">
            <span class="total-label">Ti·ªÅn b·ªëc v√°c:</span>


            <input type="text" class="form-control" id="loading-amount" value="0" readonly style="width: 90%; margin-top: 5px">
            <span id="loading-amount-error" class="error-message"></span>
          </div>

          <div class="total-row" style="display:block">
            <label class="total-label" for="order-note">üìù Ghi ch√∫:</label>
            <textarea id="order-note" class="form-control" style="width: 90%; height: 80px;margin-top: 5px" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>


          </div>

          <div class="section">
            <div class="section-header">T·ªïng</div>
            <div class="section-content">
              <div class="total-row">
                <span class="total-label">T·ªïng ti·ªÅn ph·∫£i tr·∫£:</span>
                <span class="total-value" id="total-amount">0</span>
              </div>
              <div class="total-row">
                <span class="total-label">Ti·ªÅn th·ª´a tr·∫£ kh√°ch:</span>
                <span class="total-value highlight" id="cash">0</span>
              </div>

            </div>
          </div>

          <button class="checkout-button">Thanh To√°n</button>
        </div>
      </div>
    </div>
  </div>
</div>

<footer>
  &copy; 2025 Rice Sales Management. All Rights Reserved.
</footer>

<script>

  let tabData = {}; // L∆∞u d·ªØ li·ªáu cho t·ª´ng tab
  let activeTabId = "tab-1"; // ID c·ªßa tab ƒëang ƒë∆∞·ª£c ch·ªçn

  function formatPrice(price) {
    return new Intl.NumberFormat('vi-VN').format(price);
  }

  function parsePrice(priceStr) {
    if (!priceStr) return 0;
    // Gi·ªØ d·∫•u tr·ª´ n·∫øu c√≥, r·ªìi thay th·∫ø d·∫•u ',' ho·∫∑c '.'
    if(priceStr === "0") return 0;
    return parseInt(priceStr.replace(/,/g, '').replace(/[^\d-]/g, '')) || 0;

  }


  function showProductModal() {
    document.getElementById("product-modal").style.display = "flex";
  }

  function closeProductModal() {
    document.getElementById("product-modal").style.display = "none";
  }

  document.getElementById("customer-name").readOnly = true;
  document.getElementById("customer-address").readOnly = true;
  document.getElementById("customer-phone").readOnly = true;
  document.getElementById("customer-gender").readOnly = true;
  document.getElementById("customer-dob").readOnly = true;

  document.getElementById("customer-name").addEventListener("keydown", function(event) {
    event.preventDefault(); // NgƒÉn nh·∫≠p b√†n ph√≠m
  });
  document.getElementById("customer-address").addEventListener("keydown", function(event) {
    event.preventDefault(); // NgƒÉn nh·∫≠p b√†n ph√≠m
  });
  document.getElementById("customer-phone").addEventListener("keydown", function(event) {
    event.preventDefault(); // NgƒÉn nh·∫≠p b√†n ph√≠m
  });
  document.getElementById("customer-gender").addEventListener("keydown", function(event) {
    event.preventDefault(); // NgƒÉn nh·∫≠p b√†n ph√≠m
  });
  document.getElementById("customer-dob").addEventListener("keydown", function(event) {
    event.preventDefault(); // NgƒÉn nh·∫≠p b√†n ph√≠m
  });
  document.getElementById("customer-name").addEventListener("contextmenu", function(event) {
    event.preventDefault();
  });
  document.getElementById("customer-address").addEventListener("contextmenu", function(event) {
    event.preventDefault();// Ch·∫∑n chu·ªôt ph·∫£i
  });
  document.getElementById("customer-phone").addEventListener("contextmenu", function(event) {
    event.preventDefault();// Ch·∫∑n chu·ªôt ph·∫£i
  });
  document.getElementById("customer-gender").addEventListener("contextmenu", function(event) {
    event.preventDefault();// Ch·∫∑n chu·ªôt ph·∫£i
  });
  document.getElementById("customer-dob").addEventListener("contextmenu", function(event) {
    event.preventDefault();// Ch·∫∑n chu·ªôt ph·∫£i
  });


  /* H√†m t√¨m ki·∫øm s·∫£n ph·∫©m */
  function searchProduct() {
    let keyword = document.getElementById("search-product").value;
    let productList = document.getElementById("product-list");
    if (keyword.length >= 1) {

      fetch(`/bill/searchProducts?keyword=${keyword}`)
              .then(response => response.json())
              .then(data => {
                if (data.length === 0) {
                  productList.innerHTML = "<p>Kh√¥ng c√≥ s·∫£n ph·∫©m</p>"; // N·∫øu kh√¥ng c√≥ k·∫øt qu·∫£
                } else {
                  data.forEach(product => {
                    // N·∫øu packageType l√† m·ªôt chu·ªói JSON, parse n√≥
                    console.log("aaaa: "+product.packageType);
                    console.log(product);

                    console.log("aaaa: "+product.packageType);
                  });
                  productList.innerHTML = data.map(product => `
  <div class="product-item"
      onclick='selectProduct(${product.id}, "${product.name}", ${product.price}, ${JSON.stringify(product.packageType)})'>
      <img width="100px" src="${product.image}"/> ${product.name} - ${product.price} VND - ${product.quantity} kg
  </div>
`).join("");

                  console.log(data);
                }
              })
              .catch(error => console.error("L·ªói t√¨m ki·∫øm:", error));
    } else {
      document.getElementById("product-list").innerHTML = "<p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>";
    }
  }


  /* Khi ch·ªçn s·∫£n ph·∫©m, th√™m v√†o h√≥a ƒë∆°n v√† ƒë√≥ng modal */
  function selectProduct(id, name, price, packageTypeJson) {
    console.log("D·ªØ li·ªáu nh·∫≠n v√†o tr∆∞·ªõc khi parse:", packageTypeJson);

    let packageType;

    try {
      // N·∫øu packageTypeJson ƒë√£ l√† m·∫£ng, kh√¥ng c·∫ßn parse l·∫°i
      if (typeof packageTypeJson === "string") {
        packageType = JSON.parse(packageTypeJson);
      } else {
        packageType = packageTypeJson;
      }

      if (!Array.isArray(packageType)) {
        console.error("L·ªói: packageType kh√¥ng ph·∫£i l√† m·∫£ng h·ª£p l·ªá!", packageTypeJson);
        packageType = [];
      }
      console.log(packageType);
    } catch (error) {
      console.error("‚ùå L·ªói khi parse packageType:", error, "Gi√° tr·ªã nh·∫≠n v√†o:", packageTypeJson);
      packageType = [];
    }

    if (!tabData[activeTabId]) {
      console.warn(`‚ö†Ô∏è tabData[${activeTabId}] ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o!`);
      tabData[activeTabId] = { customer: {}, products: [], payment: [] };
    }

    if (!Array.isArray(tabData[activeTabId].products)) {
      console.warn(`‚ö†Ô∏è tabData[${activeTabId}].products kh√¥ng ph·∫£i l√† m·∫£ng!`);
      tabData[activeTabId].products = [];
    }

    let defaultPackage = packageType.length > 0 ? packageType[0] : { id: "", name: "1kg" };

    tabData[activeTabId].products.push({
      id,
      name,
      price,
      quantity: 1,
      packageType: packageType,
      selectedPackage: packageType.length > 0 ? packageType[0].id : "" ,// M·∫∑c ƒë·ªãnh ch·ªçn package ƒë·∫ßu ti√™n n·∫øu c√≥
      selectedPackageSize: parseInt(defaultPackage.name) || 1
    });
    console.log(tabData[activeTabId].products);


    document.getElementById("search-product").value = "";
    document.getElementById("product-list").innerHTML = "<p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>";
    closeProductModal();
    renderProducts(activeTabId);
    updateOrderTotal(activeTabId);
  }




  // M·ªü popup t√¨m ki·∫øm kh√°ch h√†ng
  document.getElementById("search-customer-btn").addEventListener("click", function () {
    document.getElementById("customer-search-modal").style.display = "flex";
  });

  // ƒê√≥ng popup t√¨m ki·∫øm kh√°ch h√†ng
  function closeCustomerSearchModal() {
    document.getElementById("customer-search-modal").style.display = "none";
  }

  // M·ªü popup th√™m kh√°ch h√†ng
  document.getElementById("add-customer-btn").addEventListener("click", function () {
    document.getElementById("add-customer-modal").style.display = "flex";
  });

  // ƒê√≥ng popup th√™m kh√°ch h√†ng
  function closeAddCustomerModal() {
    document.getElementById("add-customer-modal").style.display = "none";
  }




  // L·∫Øng nghe s·ª± ki·ªán thay ƒë·ªïi tr√™n c√°c √¥ nh·∫≠p th√¥ng tin kh√°ch h√†ng
  document.getElementById("customer-name").addEventListener("input", updateCustomerData);
  document.getElementById("customer-phone").addEventListener("input", updateCustomerData);
  document.getElementById("customer-address").addEventListener("input", updateCustomerData);
  document.getElementById("customer-dob").addEventListener("input", updateCustomerData);
  document.getElementById("customer-gender").addEventListener("input", updateCustomerData);

  // H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu v√†o tab hi·ªán t·∫°i
  function updateCustomerData() {
    if (!tabData[activeTabId]) {
      tabData[activeTabId] = { customer: {}, products: [] };
    }

    tabData[activeTabId].customer = {
      name: document.getElementById("customer-name").value.trim(),
      phone: document.getElementById("customer-phone").value.trim(),
      address: document.getElementById("customer-address").value.trim(),
      dob: document.getElementById("customer-dob").value.trim(),
      gender: document.getElementById("customer-gender").value.trim()


    };

    console.log(`C·∫≠p nh·∫≠t kh√°ch h√†ng cho tab ${activeTabId}:`, tabData[activeTabId].customer);
  }

  function searchCustomer() {
    let keyword = document.getElementById("search-customer-input").value.trim();
    let customerList = document.getElementById("customer-list");

    if (keyword.length >= 1) {
      customerList.style.display = "block";
      customerList.innerHTML = "<p>ƒêang t√¨m ki·∫øm...</p>";

      fetch(`/bill/searchCustomers?keyword=${keyword}`)
              .then(response => response.json())
              .then(data => {
                if (data.length === 0) {
                  customerList.innerHTML = `<p>Kh√¥ng c√≥ kh√°ch h√†ng.</p>`;
                } else {
                  customerList.innerHTML = data.map(customer => `
                        <div class="customer-item" onclick="selectCustomer(
                            '${customer.name}',
                            '${customer.phone}',
                            '${customer.address}',
                            '${customer.dob}',
                            '${customer.gender}'
                        )">

                            ${customer.name} - ${customer.phone}
                        </div>

                    `).join("");
                }
              })
              .catch(error => {
                console.error("L·ªói t√¨m ki·∫øm:", error);
                customerList.innerHTML = "<p>L·ªói khi t√¨m ki·∫øm</p>";
              });
    } else {
      customerList.innerHTML = "";
      customerList.style.display = "none";
    }

  }

  // Ch·ªçn kh√°ch h√†ng t·ª´ danh s√°ch
  function selectCustomer(name, phone, address,dob,gender) {
    document.getElementById("customer-name").value = name;
    document.getElementById("customer-phone").value = phone;
    document.getElementById("customer-address").value = address;
    document.getElementById("customer-dob").value = dob;
    document.getElementById("customer-gender").value = (gender === "true") ? "Nam" : "N·ªØ";
    console.log(gender)
    if (!tabData[activeTabId]) {
      tabData[activeTabId] = { customer: {}, products: [] };
    }

    // L∆∞u t√™n kh√°ch h√†ng ban ƒë·∫ßu
    tabData[activeTabId].originalCustomerName = name;

    tabData[activeTabId].customer = { name, phone, address ,dob,gender  };
    // ƒê·∫∑t readonly

    document.getElementById("customer-name").readOnly = true;
    document.getElementById("customer-phone").readOnly = true;
    document.getElementById("customer-address").readOnly = true;
    document.getElementById("customer-dob").readOnly = true;
    document.getElementById("customer-gender").readOnly = true;

    // ƒê√≥ng popup
    closeCustomerSearchModal();
    saveCustomerData(activeTabId);
  }


  function renderProducts(tabId) {
    let productTable = document.getElementById("selected-products");
    productTable.innerHTML = "";

    if (!tabData[tabId] || !Array.isArray(tabData[tabId].products)) {
      console.warn(`‚ö†Ô∏è tabData[${tabId}].products kh√¥ng t·ªìn t·∫°i ho·∫∑c kh√¥ng ph·∫£i m·∫£ng!`);
      tabData[tabId] = { customer: {}, products: [], payment: [] };
    }

    console.log("Danh s√°ch s·∫£n ph·∫©m tr∆∞·ªõc khi render:", tabData[tabId].products);


    console.log("Danh s√°ch s·∫£n ph·∫©m:", tabData[tabId].products);

    tabData[tabId].products.forEach((product, index) => {
      // Ki·ªÉm tra n·∫øu product kh√¥ng c√≥ packageType th√¨ g√°n m·∫£ng r·ªóng
      let packageTypes = Array.isArray(product.packageType) ? product.packageType : [];
      console.log("Danh s√°ch packageType c·ªßa s·∫£n ph·∫©m:", packageTypes);
      console.log(product.selectedPackage);
      let packageOptions = packageTypes.map(pkg => `
            <option value="${pkg.id}" ${pkg.id === product.selectedPackage ? "selected" : ""}>${pkg.name}</option>
        `).join("");
      packageTypes.forEach((type, index) => {
        console.log(type.id );
        console.log(product.selectedPackage);
        console.log(type.id === product.selectedPackage);
      });

      let row = `
            <tr id="product-${index}">
                <td>${index + 1}</td>
                <td>${product.name}</td>
                <td>
                    <select style="margin-left: 40%" onchange="changePackageType('${tabId}', ${index}, this.value)">
                        ${packageOptions}
                    </select>
                </td>
                <td class="quantity-cell">
                    <span class="quantity-value">${product.quantity}</span>
                    <div class="quantity-controls">
                        <div class="quantity-btn minus" onclick="changeQuantity('${tabId}',${product.id}, ${product.selectedPackage}, -1)">-</div>
                        <div class="quantity-btn plus" onclick="changeQuantity('${tabId}', ${product.id}, ${product.selectedPackage}, 1)">+</div>
                    </div>
                </td>
                <td class="price-cell">${formatPrice(product.price) + "/kg"}</td>
                <td class="price-cell total-price">${formatPrice(product.price * product.quantity *(product.selectedPackageSize || 1))}</td>
                <td><button onclick="removeProduct('${tabId}', ${index})" style="margin-left: 20px">‚úñ</button></td>
            </tr>
        `;
      productTable.insertAdjacentHTML("beforeend", row);
    });
  }


  function changePackageType(tabId, index, selectedId) {
    let product = tabData[tabId].products[index];
    if (!product) return;

    console.log(typeof product.packageType);
    console.log(typeof selectedId);
    let selectedPackage = product.packageType.find(pkg => parseInt(pkg.id) === parseInt(selectedId));

    console.log(selectedPackage)
    if (!selectedPackage) {
      console.error(`‚ùå Kh√¥ng t√¨m th·∫•y package v·ªõi ID ${selectedId}`);
      return;
    }

    product.selectedPackage = selectedPackage.id;
    product.selectedPackageSize = parseFloat(selectedPackage.name.match(/\d+/)) || 1; // L·∫•y s·ªë t·ª´ t√™n package

    console.log(`‚úÖ Package ƒë√£ ch·ªçn: ID = ${product.selectedPackage}, Size = ${product.selectedPackageSize}kg`);

    renderProducts(tabId);
    updateOrderTotal();
  }




  function changeQuantity(tabId, id,packageId, change) {
    let product = tabData[tabId].products.find(p => p.id === id&& p.selectedPackage === packageId);
    console.log(tabData[tabId].products);
    console.log(id);
    console.log(product);
    if (!product) return;

    let newQuantity = product.quantity + change;
    if (newQuantity < 1) return; // Kh√¥ng cho s·ªë l∆∞·ª£ng √¢m


    // ‚úÖ N·∫øu gi·∫£m s·ªë l∆∞·ª£ng, c·∫≠p nh·∫≠t ngay l·∫≠p t·ª©c
    product.quantity = Math.max(1, newQuantity);
    renderProducts(tabId);
    updateOrderTotal(tabId);

  }


  function removeProduct(tabId, index) {
    if (!tabData[tabId] || !Array.isArray(tabData[tabId].products)) return;

    // Ch·ªâ x√≥a ph·∫ßn t·ª≠ t·∫°i index c·ª• th·ªÉ
    tabData[tabId].products.splice(index, 1);

    renderProducts(tabId);
    updateOrderTotal(tabId);
  }


  document.getElementById("loading").addEventListener("change", function () {
    let loadingAmountInput = document.getElementById("loading-amount");
    console.log(loadingAmountInput);
    if (this.checked) {
      loadingAmountInput.removeAttribute("readonly"); // Cho ph√©p nh·∫≠p ti·ªÅn b·ªëc h√†ng
    } else {
      loadingAmountInput.setAttribute("readonly", true); // Kh√¥ng cho ph√©p nh·∫≠p
      loadingAmountInput.value = "0"; // ƒê·∫∑t l·∫°i v·ªÅ 0 khi b·ªè ch·ªçn
    }

    updateOrderTotal(activeTabId);
  });


  document.getElementById("customer-payment").addEventListener("input", function (event) {
    let input = event.target.value.replaceAll(".", ""); // X√≥a d·∫•u . c≈© tr∆∞·ªõc khi ki·ªÉm tra
    let cleanNumber = input.replace(/\D/g, ""); // Lo·∫°i b·ªè k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
    let errorSpan = document.getElementById("customer-payment-error");
    let customerPayment= parsePrice(document.getElementById("customer-payment").value) ;
    let productTotal = 0; // M·∫∑c ƒë·ªãnh t·ªïng ti·ªÅn s·∫£n ph·∫©m l√† 0 n·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
    if (tabData[activeTabId] && tabData[activeTabId].products) {
      productTotal = tabData[activeTabId].products.reduce((sum, product) =>
              sum + (product.price * product.quantity * (product.selectedPackageSize || 1)), 0
      );
    }
    console.log(productTotal);

    // L·∫•y ti·ªÅn b·ªëc h√†ng n·∫øu checkbox "B·ªëc h√†ng" ƒë∆∞·ª£c ch·ªçn
    let loadingFee = document.getElementById("loading").checked ? parsePrice(document.getElementById("loading-amount").value) : 0;

    let discount = parsePrice(document.getElementById("discount").value);
    let loadingAmount= document.getElementById("loading-amount").value;
    let numericLoadingAmount = Number(loadingAmount.replace(/\./g, "")); // Lo·∫°i b·ªè t·∫•t c·∫£ d·∫•u "."

    if(loadingFee<0|| isNaN(numericLoadingAmount)) loadingFee = 0;
    if(discount<0 || discount>100||isNaN(document.getElementById("discount").value)) discount = 0
    let finalTotal = (productTotal + loadingFee)- discount*(productTotal + loadingFee)/100;
    console.log(finalTotal);

    if (cleanNumber === "") {
      event.target.value = "";
      errorSpan.textContent = ""; // Kh√¥ng hi·ªÉn th·ªã l·ªói khi input r·ªóng
      event.target.classList.remove("input-error");
      customerPayment = 0;
      document.getElementById("cash").textContent = "0";
      console.log(document.getElementById("customer-payment").value);
      return;
    }

    // Ki·ªÉm tra n·∫øu gi√° tr·ªã nh·∫≠p kh√¥ng ph·∫£i s·ªë nguy√™n d∆∞∆°ng
    if (!/^\d+$/.test(cleanNumber)) {
      errorSpan.textContent = "Please enter a positive integer!";
      event.target.classList.add("input-error");
      return;
    } else {
      errorSpan.textContent = "";
      event.target.classList.remove("input-error");
      document.getElementById("cash").textContent = formatPrice(Math.round(customerPayment-finalTotal));

    }

    // ƒê·ªãnh d·∫°ng l·∫°i s·ªë ti·ªÅn v·ªõi d·∫•u . m·ªói 3 ch·ªØ s·ªë
    let formattedNumber = cleanNumber.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    event.target.value = formattedNumber;




  });

  document.getElementById("order-note").addEventListener("input", function () {
    if (!tabData[activeTabId]) {
      tabData[activeTabId] = { customer: {}, products: [], payment: {}, note: "" };
    }
    tabData[activeTabId].note = this.value;
  });





  function updateOrderTotal() {
    let productTotal = 0; // M·∫∑c ƒë·ªãnh t·ªïng ti·ªÅn s·∫£n ph·∫©m l√† 0 n·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
    if (tabData[activeTabId] && tabData[activeTabId].products) {
      productTotal = tabData[activeTabId].products.reduce((sum, product) =>
              sum + (product.price * product.quantity * (product.selectedPackageSize || 1)), 0
      );
    }
    // ‚úÖ Hi·ªÉn th·ªã ho·∫∑c ·∫©n d√≤ng Total d∆∞·ªõi b·∫£ng s·∫£n ph·∫©m
    const productTotalContainer = document.getElementById("product-total-container");
    if (tabData[activeTabId].products.length > 0) {
      productTotalContainer.style.display = "block";
      document.getElementById("product-total-value").textContent = formatPrice(productTotal);
    } else {
      productTotalContainer.style.display = "none";
    }

    console.log(productTotal);

    // L·∫•y ti·ªÅn b·ªëc h√†ng n·∫øu checkbox "B·ªëc h√†ng" ƒë∆∞·ª£c ch·ªçn
    let loadingFee = document.getElementById("loading").checked ? parsePrice(document.getElementById("loading-amount").value) : 0;
    console.log(document.getElementById("loading-amount").value);
    console.log( isNaN(document.getElementById("loading-amount").value))
    let discount = parsePrice(document.getElementById("discount").value);
    let loadingAmount= document.getElementById("loading-amount").value;
    let numericLoadingAmount = Number(loadingAmount.replace(/\./g, "")); // Lo·∫°i b·ªè t·∫•t c·∫£ d·∫•u "."
    let numericCustomerPaymentAmount = Number(document.getElementById("customer-payment").value.replace(/\./g, ""));


    if(loadingFee<0|| isNaN(numericLoadingAmount)) loadingFee = 0;
    if(discount<0 || discount>100||isNaN(document.getElementById("discount").value)) discount = 0;
    let customerPayment= parsePrice(document.getElementById("customer-payment").value) ;
    console.log(!isNaN(customerPayment));
    let finalTotal = (productTotal + loadingFee)- discount*(productTotal + loadingFee)/100;
    console.log("finalTotal "+ finalTotal);
    console.log("customerpayment"+ customerPayment);
    document.getElementById("total-amount").textContent = formatPrice(Math.round(finalTotal));
    if(isNaN(numericCustomerPaymentAmount)){
      customerPayment = 0;
    }
    if(!document.getElementById("customer-payment").value){
      customerPayment = 0;
      document.getElementById("cash").textContent = "0";
      console.log(document.getElementById("customer-payment").value);
    }

    else{
      document.getElementById("cash").textContent = formatPrice(Math.round(customerPayment-finalTotal));

    }




  }
  // G√°n s·ª± ki·ªán khi nh·∫≠p ti·ªÅn b·ªëc h√†ng s·∫Ω c·∫≠p nh·∫≠t t·ªïng ti·ªÅn ngay l·∫≠p t·ª©c
  document.getElementById("loading-amount").addEventListener("input", function (event) {
    if (document.getElementById("loading").checked) {
      let input = event.target.value.replaceAll(".", ""); // X√≥a d·∫•u . c≈© tr∆∞·ªõc khi ki·ªÉm tra
      let cleanNumber = input.replace(/\D/g, ""); // Lo·∫°i b·ªè k√Ω t·ª± kh√¥ng ph·∫£i s·ªë
      let errorSpan = document.getElementById("loading-amount-error");



      if (input=== "") {
        errorSpan.textContent = ""; // N·∫øu tr·ªëng th√¨ kh√¥ng hi·ªÉn th·ªã l·ªói
        event.target.classList.remove("input-error");
        let productTotal = 0; // M·∫∑c ƒë·ªãnh t·ªïng ti·ªÅn s·∫£n ph·∫©m l√† 0 n·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
        if (tabData[activeTabId] && tabData[activeTabId].products) {
          productTotal = tabData[activeTabId].products.reduce((sum, product) => sum + product.price * product.quantity, 0);
        }

        // L·∫•y ti·ªÅn b·ªëc h√†ng n·∫øu checkbox "B·ªëc h√†ng" ƒë∆∞·ª£c ch·ªçn
        let loadingFee = document.getElementById("loading").checked ? parsePrice(document.getElementById("loading-amount").value) : 0;
        console.log(document.getElementById("loading-amount").value);
        let discount = parsePrice(document.getElementById("discount").value);

        if(loadingFee<0|| isNaN(document.getElementById("loading-amount").value)) loadingFee = 0;
        if(discount<0 || discount>100||isNaN(document.getElementById("discount").value)) discount = 0;


        let finalTotal = (productTotal + loadingFee)- discount*(productTotal + loadingFee)/100;
        let customerPayment= parsePrice(document.getElementById("customer-payment").value);
        let numericCustomerPaymentAmount = Number(document.getElementById("customer-payment").value.replace(/\./g, ""));
        if(isNaN(numericCustomerPaymentAmount)) customerPayment = 0;
        document.getElementById("total-amount").textContent = formatPrice(Math.round(finalTotal));
        document.getElementById("customer-pay").textContent = formatPrice(Math.round(finalTotal));
        if(!document.getElementById("customer-payment").value){
          customerPayment = 0;
          document.getElementById("cash").textContent = "0";
          console.log(document.getElementById("customer-payment").value);
        }

        else{
          document.getElementById("cash").textContent = formatPrice(Math.round(customerPayment-finalTotal));
        }

        return;
      }
      // Ki·ªÉm tra n·∫øu gi√° tr·ªã nh·∫≠p kh√¥ng ph·∫£i s·ªë nguy√™n d∆∞∆°ng
      if (!/^\d+$/.test(cleanNumber)) {
        errorSpan.textContent = "Please enter a positive integer!";
        event.target.classList.add("input-error");
        return;
      } else {
        errorSpan.textContent = "";
        event.target.classList.remove("input-error");
      }

      // ƒê·ªãnh d·∫°ng l·∫°i s·ªë ti·ªÅn v·ªõi d·∫•u . m·ªói 3 ch·ªØ s·ªë
      let formattedNumber = cleanNumber.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      event.target.value = formattedNumber;

      // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn ngay khi nh·∫≠p ti·ªÅn b·ªëc h√†ng
      updateOrderTotal();
    }
  });

  // G√°n s·ª± ki·ªán khi nh·∫≠p ti·ªÅn b·ªëc h√†ng s·∫Ω c·∫≠p nh·∫≠t t·ªïng ti·ªÅn ngay l·∫≠p t·ª©c
  document.getElementById("discount").addEventListener("input", function (event) {

    let inputValue = event.target.value;
    let errorSpan = document.getElementById("discount-error");


    if (inputValue === "") {
      errorSpan.textContent = ""; // N·∫øu tr·ªëng th√¨ kh√¥ng hi·ªÉn th·ªã l·ªói
      event.target.classList.remove("input-error");
      let productTotal = 0; // M·∫∑c ƒë·ªãnh t·ªïng ti·ªÅn s·∫£n ph·∫©m l√† 0 n·∫øu ch∆∞a c√≥ s·∫£n ph·∫©m n√†o
      if (tabData[activeTabId] && tabData[activeTabId].products) {
        productTotal = tabData[activeTabId].products.reduce((sum, product) => sum + product.price * product.quantity, 0);
      }
      // L·∫•y ti·ªÅn b·ªëc h√†ng n·∫øu checkbox "B·ªëc h√†ng" ƒë∆∞·ª£c ch·ªçn
      let loadingFee = document.getElementById("loading").checked ? parsePrice(document.getElementById("loading-amount").value) : 0;
      console.log(document.getElementById("loading-amount").value);
      let discount = parsePrice(document.getElementById("discount").value);
      let loadingAmount= document.getElementById("loading-amount").value;
      let numericLoadingAmount = Number(loadingAmount.replace(/\./g, "")); // Lo·∫°i b·ªè t·∫•t c·∫£ d·∫•u "."

      if(loadingFee<0|| isNaN(numericLoadingAmount)) loadingFee = 0;
      if(discount<0 || discount>100||isNaN(document.getElementById("discount").value)) discount = 0;


      let finalTotal = (productTotal + loadingFee)- discount*(productTotal + loadingFee)/100;
      document.getElementById("total-amount").textContent = formatPrice(Math.round(finalTotal));
      document.getElementById("customer-pay").textContent = formatPrice(Math.round(finalTotal));
      let customerPayment= parsePrice(document.getElementById("customer-payment").value);
      let numericCustomerPaymentAmount = Number(document.getElementById("customer-payment").value.replace(/\./g, ""));
      if(isNaN(numericCustomerPaymentAmount)) customerPayment = 0;
      document.getElementById("total-amount").textContent = formatPrice(Math.round(finalTotal));
      document.getElementById("customer-pay").textContent = formatPrice(Math.round(finalTotal));
      if(!document.getElementById("customer-payment").value){
        customerPayment = 0;
        document.getElementById("cash").textContent = "0";
        console.log(document.getElementById("customer-payment").value);
      }

      else{
        document.getElementById("cash").textContent = formatPrice(Math.round(customerPayment-finalTotal));
      }
      return;
    }
    console.log(inputValue)
    // Ki·ªÉm tra n·∫øu nh·∫≠p kh√¥ng ph·∫£i s·ªë d∆∞∆°ng
    if (!/^\d+$/.test(inputValue)) {
      errorSpan.textContent = "Vui l√≤ng nh·∫≠p s·ªë nguy√™n d∆∞∆°ng!";
      event.target.classList.add("input-error");
      event.preventDefault();
      updateOrderTotal();
      return;

    } else if(parseInt(inputValue) > 100) {
      errorSpan.textContent = "Vui l√≤ng nh·∫≠p s·ªë nh·ªè h∆°n ho·∫∑c b·∫±ng 100!";
      event.target.classList.add("input-error");
      event.preventDefault();
      updateOrderTotal();
      return;
    } else if(isNaN(inputValue)) {
      errorSpan.textContent = "Vui l√≤ng nh·∫≠p s·ªë nguy√™n d∆∞∆°ng!";
      event.target.classList.add("input-error");
      event.preventDefault();
      updateOrderTotal();
      return;
    }
    else {
      errorSpan.textContent = "";
      event.target.classList.remove("input-error");
    }

    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn ngay khi nh·∫≠p ti·ªÅn b·ªëc h√†ng
    updateOrderTotal();

  });

  // X·ª≠ l√Ω t·∫°o v√† chuy·ªÉn tab
  document.querySelector(".add-tab").addEventListener("click", function () {
    let existingNumbers = [...document.querySelectorAll(".tab")]
            .map(tab => parseInt(tab.querySelector(".tab-title").textContent.replace("H√≥a ƒë∆°n ", "")))
            .filter(n => !isNaN(n)); // L·∫•y danh s√°ch c√°c s·ªë h√≥a ƒë∆°n hi·ªán t·∫°i

    let newNumber = 1;
    while (existingNumbers.includes(newNumber)) {
      newNumber++; // T√¨m s·ªë nh·ªè nh·∫•t ch∆∞a ƒë∆∞·ª£c d√πng
    }
    let tabId = `tab-${Date.now()}`; // S·ª≠ d·ª•ng timestamp ƒë·ªÉ t·∫°o ID duy nh·∫•t
    tabData[tabId] = { customer: {}, products: [], payment: {discount: null, customerPayment: 0, loading: false, loadingAmount: 0 } };


    let newTab = document.createElement("div");
    newTab.className = "tab";
    newTab.setAttribute("data-tab", tabId);
    newTab.innerHTML = `
        <span class="tab-title">H√≥a ƒë∆°n ${newNumber}</span>
        <span class="tab-close">√ó</span>
    `;

    newTab.addEventListener("click", function () {
      switchTab(tabId);
    });

    newTab.querySelector(".tab-close").addEventListener("click", function (e) {
      e.stopPropagation();
      delete tabData[tabId];
      newTab.remove();
      if (document.querySelectorAll(".tab").length > 0) {
        let firstTab = document.querySelector(".tab");
        switchTab(firstTab.getAttribute("data-tab"));
      }
    });

    // ‚úÖ Ch√®n tab v√†o ƒë√∫ng v·ªã tr√≠ thay v√¨ ch·ªâ ƒë·∫∑t tr∆∞·ªõc d·∫•u +
    let tabContainer = document.querySelector(".tab-container");
    let tabs = [...tabContainer.querySelectorAll(".tab")];

    let inserted = false;
    for (let tab of tabs) {
      let tabNumber = parseInt(tab.querySelector(".tab-title").textContent.replace("Bill ", ""));
      if (newNumber < tabNumber) {
        tabContainer.insertBefore(newTab, tab);
        inserted = true;
        break;
      }
    }

    if (!inserted) {
      tabContainer.insertBefore(newTab, document.querySelector(".add-tab"));
    }

    switchTab(tabId);
  });

  function saveCustomerData(tabId) {
    if (!tabData[tabId]) tabData[tabId] = { customer: {}, products: [] };

    tabData[tabId].customer = {
      name: document.getElementById("customer-name").value.trim(),
      phone: document.getElementById("customer-phone").value.trim(),
      address: document.getElementById("customer-address").value.trim(),
      dob: document.getElementById("customer-dob").value.trim(),
      gender: document.getElementById("customer-gender").value.trim(),
    };
    console.log(tabData[tabId].customer);
  }


  function switchTab(tabId) {
    savePaymentData(activeTabId);
    saveCustomerData(activeTabId);
    // N·∫øu tab ch∆∞a c√≥ d·ªØ li·ªáu, kh·ªüi t·∫°o m·ªõi

    activeTabId = tabId;
    document.querySelectorAll(".tab").forEach(tab => tab.classList.remove("active"));
    document.querySelector(`[data-tab="${tabId}"]`).classList.add("active");


    if (!tabData[tabId]) {
      tabData[tabId] = { customer: {}, products: [], payment: {discount: null, customerPayment: 0, loading: false, loadingAmount: 0 } , status: null , note: "" };
    }
    document.getElementById("order-note").value = tabData[tabId].note || ""; // Load ghi ch√∫ c·ªßa tab

    renderProducts(tabId);
    loadPaymentData(tabId);
    updateOrderTotal(tabId);
    updateOrderStatus(tabId);

    // Reset v√† c·∫≠p nh·∫≠t l·ª±a ch·ªçn thanh to√°n
    // Reset th√¥ng tin kh√°ch h√†ng khi chuy·ªÉn tab
    loadCustomerData(tabId);
  }

  function savePaymentData(tabId) {
    if (!tabData[tabId]) {
      tabData[tabId] = { customer: {}, products: [], payment: {} }; // Kh·ªüi t·∫°o n·∫øu ch∆∞a c√≥
    }
    console.log(document.getElementById("customer-payment").value)
    tabData[tabId].payment = {
      discount: document.getElementById("discount").value,
      customerPayment: document.getElementById("customer-payment").value,
      loading: document.getElementById("loading").checked,
      loadingAmount: document.getElementById("loading-amount").value
    };
  }

  function loadPaymentData(tabId) {
    let customer = tabData[tabId]?.customer || {};
    let paymentData = tabData[tabId]?.payment || { discount: null,customerPayment: 0, loading: false, loadingAmount: 0 };
    let exist = typeof customer.name !== "undefined" && customer.name !== "";
    // Reset l·∫°i radio button v√† checkbox
    console.log(paymentData.method);
    document.getElementById("loading").checked = paymentData.loading;
    console.log("discount: " + paymentData.discount);
    document.getElementById("discount").value = paymentData.discount;

    // Hi·ªÉn th·ªã ti·ªÅn b·ªëc h√†ng
    let loadingAmountInput = document.getElementById("loading-amount");
    loadingAmountInput.value = paymentData.loadingAmount;
    loadingAmountInput.readOnly = !paymentData.loading;
    console.log(document.getElementById("customer-payment").value);
    console.log(tabData[tabId].payment.customerPayment);
    if(tabData[tabId].payment.customerPayment !== 0 ) {
      document.getElementById("customer-payment").value = tabData[tabId].payment.customerPayment;
    }
    else{
      document.getElementById("customer-payment").value = "";
    }
  }


  function loadCustomerData(tabId) {
    let customer = tabData[tabId]?.customer || {};
    console.log(customer+" bccccc");
    let payment = tabData[tabId]?.payment || {};
    let exist = typeof customer.name !== "undefined" && customer.name !== "";

    document.getElementById("customer-name").value = customer.name || "";
    document.getElementById("customer-phone").value = customer.phone || "";
    document.getElementById("customer-address").value = customer.address || "";
    document.getElementById("customer-dob").value = customer.dob || "";
    console.log(customer.gender === "Nam");

    if(customer.gender){
      document.getElementById("customer-gender").value= (customer.gender==="Nam") ? "Nam" : "N·ªØ";
    }
    else{
      document.getElementById("customer-gender").value =  "";
    }

  }


  document.querySelector(".checkout-button").addEventListener("click", function () {
    let customerName = document.getElementById("customer-name").value.trim();
    let customerPhone = document.getElementById("customer-phone").value.trim();
    let customerAddress = document.getElementById("customer-address").value.trim();
    let customerPayment = parsePrice(document.getElementById("customer-payment").value);
    let loadingFee = parsePrice(document.getElementById("loading-amount").value);
    let isLoadingChecked = document.getElementById("loading").checked;
    let discount= parsePrice(document.getElementById("discount").value)
    console.log(parsePrice(document.getElementById("total-amount").textContent));
    if (!customerName || !customerPhone) {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Vui l√≤ng nh·∫≠p th√¥ng tin kh√°ch h√†ng!"
      });
      return;
    }

    if (customerPayment <= 0 || isNaN(customerPayment)) {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Vui l√≤ng nh·∫≠p s·ªë ti·ªÅn kh√°ch thanh to√°n!"
      });
      return;
    }

    let products = tabData[activeTabId]?.products || [];
    if (products.length === 0) {
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Vui l√≤ng th√™m √≠t nh·∫•t 1 s·∫£n ph·∫©m!"
      });
      return;
    }

    if(discount< 0||discount>100||isNaN(document.getElementById("discount").value)){
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Vui l√≤ng nh·∫≠p gi·∫£m gi√° h·ª£p l·ªá!"
      });
      return;
    }

    let loadingAmount= document.getElementById("loading-amount").value;
    let numericLoadingAmount = Number(loadingAmount.replace(/\./g, "")); // Lo·∫°i b·ªè t·∫•t c·∫£ d·∫•u "."

    if(loadingFee < 0||isNaN(numericLoadingAmount)){
      Swal.fire({
        icon: "error",
        title: "Oops...",
        text: "Please enter a valid loading amount!"
      });
      return;
    }

    let debt= parsePrice(document.getElementById("total-amount").textContent) - customerPayment;


    let statusEle =   "üïí Processing...";

    // L∆∞u tr·∫°ng th√°i v√†o tabData
    tabData[activeTabId].status = statusEle;

    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã tr·∫°ng th√°i
    updateOrderStatus(activeTabId);

    let billData = {
      totalMoney: parsePrice(document.getElementById("total-amount").textContent) ,
      paidMoney: customerPayment ,
      debtMoney: debt,
      productData: JSON.stringify(products),
      customerData: JSON.stringify({name: customerName, phone: customerPhone, address: customerAddress}),
      ported: isLoadingChecked,
      portedMoney: loadingFee ,
      discount: discount,
      note: tabData[activeTabId].note // G·ª≠i ghi ch√∫
    };

    fetch("/bill/checkout", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(billData)
    })
            .then(response => response.json())
            .then(data => {
              console.log(data.trackingId);
              if (data.success) {

                checkBillStatus(data.trackingId, activeTabId); // ‚úÖ Ki·ªÉm tra tr·∫°ng th√°i x·ª≠ l√Ω
              } else {
                alert("L·ªói khi t·∫°o h√≥a ƒë∆°n: " + data.message);
                tabData[activeTabId].status = "‚ùå Failed";
                updateOrderStatus(activeTabId);
              }
            })
            .catch(error => {
              console.error("Error sending data:", error);
              alert("An error occurred while processing payment.");
            });
  });
  function closeTab(tabId) {
    let tabToRemove = document.querySelector(`.tab[data-tab="${tabId}"]`);
    if (!tabToRemove) return;

    delete tabData[tabId]; // X√≥a d·ªØ li·ªáu tab
    tabToRemove.remove(); // X√≥a tab kh·ªèi giao di·ªán

    let remainingTabs = document.querySelectorAll(".tab");
    if (remainingTabs.length > 0) {
      switchTab(remainingTabs[0].getAttribute("data-tab")); // Chuy·ªÉn sang tab ƒë·∫ßu ti√™n c√≤n l·∫°i
    } else {
      // N·∫øu kh√¥ng c√≤n tab n√†o, c√≥ th·ªÉ hi·ªÉn th·ªã m·ªôt m√†n h√¨nh tr·ªëng ho·∫∑c reset UI
      createNewTab();
    }
  }
  function createNewTab() {
    let newNumber = 1;
    let tabId = `tab-${Date.now()}`; // T·∫°o ID duy nh·∫•t cho tab
    tabData[tabId] = { customer: {}, products: [], payment: {discount: 0, customerPayment: 0, loading: false, loadingAmount: 0 } };

    let newTab = document.createElement("div");
    newTab.className = "tab active"; // ƒê·∫∑t tab m·ªõi l√† active
    newTab.setAttribute("data-tab", tabId);
    newTab.innerHTML = `
        <span class="tab-title">H√≥a ƒë∆°n ${newNumber}</span>
        <span class="tab-close">√ó</span>
    `;

    newTab.addEventListener("click", function () {
      switchTab(tabId);
    });

    newTab.querySelector(".tab-close").addEventListener("click", function (e) {
      e.stopPropagation();
      closeTab(tabId);
    });

    let tabContainer = document.querySelector(".tab-container");
    tabContainer.insertBefore(newTab, document.querySelector(".add-tab"));

    switchTab(tabId);
  }

  function checkBillStatus(trackingId, tabId) {
    let interval = setInterval(() => {
      fetch(`/bill/tracking/${trackingId}`)
              .then(response => response.json())
              .then(data => {
                if (data.status === "processed") {
                  tabData[tabId].status = "‚úÖ Successful";
                  updateOrderStatus(tabId);
                  clearInterval(interval);
                  // ‚úÖ Sau 2 gi√¢y, ƒë√≥ng tab
                  setTimeout(() => closeTab(tabId), 1000);
                }
              })
              .catch(error => console.error("L·ªói ki·ªÉm tra tr·∫°ng th√°i h√≥a ƒë∆°n:", error));
    }, 2000);
  }


  // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i hi·ªÉn th·ªã tr√™n giao di·ªán
  function updateOrderStatus(tabId) {
    console.log(tabData[tabId].status);
    if(!tabData[tabId].status) {
      document.getElementById("order-status").style.display = "none";
    }
    else{
      let statusElement = document.getElementById("order-status");
      statusElement.textContent = `üí¨ Status: ${tabData[tabId].status}`;
      statusElement.style.display = "block";
    }

  }



</script>


</body>
</html>