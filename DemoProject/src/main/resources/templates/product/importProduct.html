<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T·∫°o h√≥a ƒë∆°n nh·∫≠p </title>
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/bill.css">
    <link rel="icon" type="image/x-icon" th:href="@{/images/account.jpg}">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="/js/home.js"></script>
    <script src="/js/importProduct.js"></script>
    <script src="/js/validateCusImported.js"></script>
    <style>
        .form-row {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }

        .form-row label {
            margin-bottom: 5px;
            font-weight: 600;
        }

        .styled-input {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        .form-row.center {
            text-align: center;
        }

        .btn-save {
            background-color: #2c3e50;
            color: white;
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }


    </style>
</head>
<body>
<div th:insert="~{layout/header :: header}"></div>

<div class="sidebar" id="sidebar">
    <div th:insert="~{layout/sidebar :: sidebar}"></div>
</div>


<!-- Content -->
<div class="content">
    <div>
        <span style="margin-left: 250px; padding-left: 50px" class="tab active">Phi·∫øu nh·∫≠p g·∫°o</span>

    </div>

    <div class="main-container">
        <div class="left-panel">
            <!-- N√∫t th√™m s·∫£n ph·∫©m -->
            <div class="add-product" id="add-product">
                <span onclick="showProductModal()">+ T√™n s·∫£n ph·∫©m</span>
                <label style="margin-left: 300px">Ng√†y nh·∫≠p:
                    <input type="date" name="importDate" id="importDate"/>
                </label>
            </div>

            <!-- Modal ch·ª©a danh s√°ch s·∫£n ph·∫©m -->
            <div id="product-modal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeProductModal()">√ó</span>
                    <h2>Ch·ªçn s·∫£n ph·∫©m</h2>
                    <input type="text" id="search-product" class="styled-input" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m..."
                           onkeyup="searchProduct()">
                    <div id="product-list" class="product-list">
                        <p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm...</p>
                    </div>
                </div>
            </div>

            <!-- Danh s√°ch s·∫£n ph·∫©m -->
            <div class="products-container">
                <table>
                    <thead>
                    <tr>
                        <th>#</th>
                        <th>S·∫£n ph·∫©m</th>
                        <th>Gi√° g·ªëc</th>
                        <th class="quantity-cell">SL</th>
                        <th class="price-cell">Gi√° nh·∫≠p</th>
                        <th class="price-cell">Th√†nh ti·ªÅn</th>
                        <th>Zone</th>
                        <th>X√≥a</th>
                    </tr>
                    </thead>
                    <tbody id="selected-products"></tbody>
                </table>
            </div>
        </div>

        <div class="right-panel">
            <!-- Th√¥ng tin kh√°ch h√†ng -->
            <div class="section">
                <div class="section-header">Th√¥ng tin nh√† cung c·∫•p</div>
                <div class="section-content">
                    <div class="form-group">
                        <div class="customer-buttons">
                            <button id="search-customer-btn">üîç T√¨m</button>
                            <button id="add-customer-btn">‚ûï Th√™m</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="customer-name">Kh√°ch h√†ng</label>
                        <input type="text" class="form-control" id="customer-name" style="width: 230px">
                    </div>
                    <div class="form-group">
                        <label for="customer-address">ƒê·ªãa ch·ªâ</label>
                        <input type="text" class="form-control" id="customer-address" style="width: 90%">
                    </div>
                    <div class="form-group">
                        <label for="customer-phone">S·ªë ƒëi·ªán tho·∫°i</label>
                        <input type="text" class="form-control" id="customer-phone" style="width: 90%">
                    </div>
                    <div class="form-group">
                        <label for="customer-gender">Gi·ªõi t√≠nh</label>
                        <input type="text" class="form-control" id="customer-gender" style="width: 90%">
                    </div>
                    <div class="form-group">
                        <label for="customer-dob">Ng√†y sinh</label>
                        <input type="text" class="form-control" id="customer-dob" style="width: 90%">
                    </div>
                    <div class="form-group">
                        <label for="customer-moneystate">S·ªë d∆∞</label>
                        <input type="text" class="form-control" id="customer-moneystate" style="width: 90%">
                    </div>

                </div>
            </div>

            <!-- Popup t√¨m ki·∫øm kh√°ch h√†ng -->
            <div id="customer-search-modal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeCustomerSearchModal()">&times;</span>
                    <h2>T√¨m ki·∫øm kh√°ch h√†ng</h2>
                    <input type="text" id="search-customer-input" style="width: 95%" class="styled-input" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng..." onkeyup="searchCustomer()">
                    <div id="customer-list" class="customer-list"></div>
                </div>
            </div>

            <!-- Popup th√™m kh√°ch h√†ng -->
            <div id="add-customer-modal" class="modal">
                <div class="modal-content">
                    <span class="close" onclick="closeAddCustomerModal()">&times;</span>
                    <h2>Th√™m kh√°ch h√†ng</h2>
                    <form id="addCustomer" action="/bill/addCustomer" class="create-form" method="post" onsubmit="return validateForm()">
                        <div class="form-row">
                            <label>T√™n kh√°ch h√†ng</label>
                            <input type="text" name="name" style="Nwidth: 95%"
                                   class="form-control styled-input" id="new-customer-name"
                                   oninput="validateName(this)"
                            >
                            <small class="error-message" id="name-error"></small>
                        </div>
                        <div class="form-row">
                            <label>S·ªë ƒëi·ªán tho·∫°i</label>
                            <input type="text" name="phone" style="width: 95%"
                                   class="form-control styled-input" id="new-customer-phone"
                                   oninput="validatePhone(this)"
                            >
                            <small class="error-message" id="phone-error"></small>
                        </div>
                        <div class="form-row">
                            <label>ƒê·ªãa ch·ªâ</label>
                            <input type="text" name="address" style="width: 95%" class="form-control styled-input"
                                   id="new-customer-address"
                                   oninput="validateAddress(this)"
                            >
                            <small class="error-message" id="address-error"></small>
                        </div>
                        <div class="form-row">
                            <label>Gi·ªõi t√≠nh:</label>
                            <select id="new-customer-gender" class="form-control styled-input"  style="width: 100%" name="gender">
                                <option value="true" >Nam</option>
                                <option value="false" >N·ªØ</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Ng√†y sinh</label>
                            <input type="date" style="width: 95%" class="form-control styled-input"
                                   id="new-customer-dob" name="dob" oninput="validateDob(this)">
                            <small class="error-message" id="dob-error"></small>
                        </div>
                        <button class="btn-save"  id="save-customer-btn">T·∫°o </button>
                    </form>
                </div>
            </div>

            <!-- T·ªïng c·ªông -->
            <div class="section">
                <div class="section-header">T·ªïng c·ªông</div>
                <div class="section-content">
                    <div class="total-row">
                        <span class="total-label">T·ªïng ti·ªÅn h√†ng:</span>
                        <span class="total-value" id="total-amount">0</span>
                    </div>
                    <div class="total-row">
                        <span class="total-label">C·∫ßn ph·∫£i tr·∫£:</span>
                        <span class="total-value highlight" id="customer-pay">0</span>
                    </div>
                </div>
            </div>

            <!-- Thanh to√°n -->
            <div class="section">
                <div class="section-header">Thanh to√°n</div>
                <div class="section-content">
                    <div class="total-row">
                        <span class="total-label">ƒê√£ tr·∫£ cho kh√°ch:</span>
                    </div>
                    <div class="total-row" style="display:block">
                        <input type="text" style="width: 90%" class="form-control" id="customer-payment"
                               placeholder="Nh·∫≠p s·ªë ti·ªÅn ƒë√£ thanh to√°n">
                        <span id="customer-payment-error" class="error-message"></span>
                    </div>
                    <div class="payment-method" style="margin-top: 10px">
                        <input type="checkbox" name="payment" id="loading">
                        <label for="loading" class="total-label">B·ªëc h√†ng</label>
                    </div>
                    <div class="total-row" style="display: block">
                        <span class="total-label">Ti·ªÅn b·ªëc h√†ng:</span>
                        <input type="text" class="form-control" id="loading-amount" value="0" readonly
                               style="width: 90%; margin-top: 5px">
                        <span id="loading-amount-error" class="error-message"></span>
                    </div>
                </div>
                <button class="checkout-button">THANH TO√ÅN</button>
            </div>
        </div>
    </div>
</div>

<footer>
    ¬© 2025 Rice Sales Management. All Rights Reserved.
</footer>

<script>

    // NgƒÉn ch·ªânh s·ª≠a c√°c tr∆∞·ªùng kh√°ch h√†ng
    document.getElementById("customer-name").readOnly = true;
    document.getElementById("customer-address").readOnly = true;
    document.getElementById("customer-phone").readOnly = true;
    document.getElementById("customer-gender").readOnly = true;
    document.getElementById("customer-dob").readOnly = true;
    document.getElementById("customer-moneystate").readOnly = true;

    ['customer-name', 'customer-address', 'customer-phone', 'customer-gender', 'customer-dob'].forEach(id => {
        document.getElementById(id).addEventListener("keydown", function (event) {
            event.preventDefault();
        });
        document.getElementById(id).addEventListener("contextmenu", function (event) {
            event.preventDefault();
        });
    });

    // S·ª± ki·ªán n√∫t t√¨m ki·∫øm v√† th√™m kh√°ch h√†ng
    document.getElementById("search-customer-btn").addEventListener("click", function () {
        document.getElementById("customer-search-modal").style.display = "flex";
    });

    function closeCustomerSearchModal() {
        document.getElementById("customer-search-modal").style.display = "none";
    }

    document.getElementById("add-customer-btn").addEventListener("click", function () {
        document.getElementById("add-customer-modal").style.display = "flex";
    });

    function closeAddCustomerModal() {
        document.getElementById("add-customer-modal").style.display = "none";
    }

    function validateNumber(input) {
        let value = input.value;

        let quantity = parseInt(value, 10);

        if (isNaN(quantity) || quantity < 1) {
            alert("ƒê∆°n gi√° kh√¥ng h·ª£p l·ªá!!!")
        }
    }


    // S·ª± ki·ªán checkbox "B·ªëc h√†ng"
    document.getElementById("loading").addEventListener("change", function () {
        let loadingAmountInput = document.getElementById("loading-amount");
        if (this.checked) {
            loadingAmountInput.removeAttribute("readonly");
        } else {
            loadingAmountInput.setAttribute("readonly", true);
            loadingAmountInput.value = "0";
        }
        updateOrderTotal();
        updateTotalDebt();
    });

    // C·∫≠p nh·∫≠t t·ªïng c√¥ng n·ª£ khi nh·∫≠p s·ªë ti·ªÅn thanh to√°n
    document.getElementById("customer-payment").addEventListener("input", function (event) {
        let inputValue = event.target.value.trim();
        let errorSpan = document.getElementById("customer-payment-error");
        let moneyState = parsePrice(customer.moneyState || "0");
        if (inputValue === "") {
            errorSpan.textContent = "";
            event.target.classList.remove("input-error");
            document.getElementById("customer-totaldebt").value = formatPrice(oldDebt);
            return;
        }
        if (!/^\d+$/.test(inputValue)) {
            errorSpan.textContent = "Vui l√≤ng nh·∫≠p s·ªë nguy√™n d∆∞∆°ng!";
            event.target.classList.add("input-error");
            return;
        } else {
            errorSpan.textContent = "";
            event.target.classList.remove("input-error");
        }
        updateTotalDebt();
    });

    // C·∫≠p nh·∫≠t t·ªïng c√¥ng n·ª£
    function updateTotalDebt() {
        let customerName = document.getElementById("customer-name").value.trim();
        let payment = parsePrice(document.getElementById("customer-payment").value);
        let moneyFinal = document.getElementById("customer-moneystate").value.trim();
        let totalAmount = parsePrice(document.getElementById("total-amount").textContent) || 0;

        if (customerName === "") {
            document.getElementById("customer-totaldebt").value = "";
            return;
        }

        if (payment >= 0) {
            moneyFinal = totalAmount-payment;
            document.getElementById("customer-moneystate").value = formatPrice(moneyFinal);
        }else{
            document.getElementById("customer-moneystate").value = 0;
        }
    }

    // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
    function updateOrderTotal() {
        let productTotal = products.reduce((sum, product) => sum + product.price * product.quantity, 0);
        let loadingFee = document.getElementById("loading").checked ? parsePrice(document.getElementById("loading-amount").value) : 0;
        let finalTotal = productTotal + loadingFee;
        document.getElementById("total-amount").textContent = formatPrice(finalTotal);
        document.getElementById("customer-pay").textContent = formatPrice(finalTotal);
    }

    // S·ª± ki·ªán nh·∫≠p ti·ªÅn b·ªëc h√†ng
    document.getElementById("loading-amount").addEventListener("input", function (event) {
        if (document.getElementById("loading").checked) {
            let inputValue = event.target.value;
            let errorSpan = document.getElementById("loading-amount-error");
            if (inputValue === "") {
                errorSpan.textContent = "";
                event.target.classList.remove("input-error");
                updateOrderTotal();
                updateTotalDebt();
                return;
            }
            if (!/^\d+$/.test(inputValue)) {
                errorSpan.textContent = "Vui l√≤ng nh·∫≠p s·ªë nguy√™n d∆∞∆°ng!";
                event.target.classList.add("input-error");
                return;
            } else {
                errorSpan.textContent = "";
                event.target.classList.remove("input-error");
            }
            updateOrderTotal();
            updateTotalDebt();
        }
    });

    // X·ª≠ l√Ω thanh to√°n
    document.querySelector(".checkout-button").addEventListener("click", function () {
        if (!customer.name || products.length === 0) {
            alert("Vui l√≤ng nh·∫≠p th√¥ng tin kh√°ch h√†ng v√† th√™m s·∫£n ph·∫©m!");
            return;
        }

        for (let product of products) {
            if (isNaN(product.price) || product.price <= 0) {
                alert("Gi√° s·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá!");
                return;
            }
            if (!product.zoneId) {
                alert("Vui l√≤ng ch·ªçn zone cho t·∫•t c·∫£ s·∫£n ph·∫©m!");
                return;
            }
        }

        let productList = products.map(product => ({
            id: product.id,
            image : product.image,
            name : product.name,
            quantity: product.quantity,
            price: product.price,
            subtotal: product.price * product.quantity,
            zoneId: product.zoneId,
        }));

        let requestData = {
            paidMoney : document.getElementById("customer-payment").value || 0,
            debtMoney : parsePrice(document.getElementById("customer-moneystate").value) || 0,
            portedMoney : document.getElementById("loading-amount").value || "0",
            importDate: document.getElementById("importDate").value,
            customerPhone : document.getElementById("customer-phone").value,
            productData: productList
        };

        fetch("/product/import", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(requestData)
        })
            .then(response => {
                if (response.redirected) {
                    window.location.href = response.url;
                    return;
                }
                if (!response.ok) {
                    throw new Error(`L·ªói t·ª´ server: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {

                if (data && data.success) { // Ki·ªÉm tra data t·ªìn t·∫°i
                    alert("Thanh to√°n th√†nh c√¥ng!");
                    // Reset form
                    customer = {};
                    products = [];
                    document.getElementById("customer-name").value = "";
                    document.getElementById("customer-phone").value = "";
                    document.getElementById("customer-address").value = "";
                    document.getElementById("customer-dob").value = "";
                    document.getElementById("customer-gender").value = "";
                    document.getElementById("customer-moneystate").value = "";
                    document.getElementById("customer-totaldebt").value = "";
                    document.getElementById("customer-payment").value = "";
                    document.getElementById("loading").checked = false;
                    document.getElementById("loading-amount").value = "0";
                    document.getElementById("loading-amount").setAttribute("readonly", true);
                    renderProducts();
                    updateOrderTotal();
                } else if (data) {
                    alert("L·ªói khi x·ª≠ l√Ω thanh to√°n: " + (data.message || "Kh√¥ng c√≥ th√¥ng tin l·ªói"));
                }
            })
            .catch(error => {
                console.error("L·ªói chi ti·∫øt:", error);
                alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i d·ªØ li·ªáu: " + error.message);
            });

    });

</script>
</body>
</html>